import{r as e,o as c,c as o,b as s,d as t,F as l,a,e as n}from"./app.6f963528.js";import{_ as u}from"./plugin-vue_export-helper.21dcd24c.js";const r={},i=a(`<h2 id="\u64CD\u4F5Cdom" tabindex="-1"><a class="header-anchor" href="#\u64CD\u4F5Cdom" aria-hidden="true">#</a> \u64CD\u4F5CDOM</h2><p>\u5728\u4F7F\u7528vue.js\u7684\u65F6\u5019\uFF0C\u6709\u65F6\u5019\u56E0\u4E3A\u4E00\u4E9B\u7279\u5B9A\u7684\u4E1A\u52A1\u573A\u666F\uFF0C\u4E0D\u5F97\u4E0D\u53BB\u64CD\u4F5CDOM\uFF0C\u6BD4\u5982\u8FD9\u6837\uFF1A</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{test}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleClick<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>tet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token string">&#39;begin&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">methods</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleClick</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token string">&#39;end&#39;</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>test<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6253\u5370\u201Cbegin\u201D</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>\u6253\u5370\u7684\u7ED3\u679C\u662Fbegin\uFF0C\u4E3A\u4EC0\u4E48\u660E\u660E\u5DF2\u7ECF\u5C06test\u8BBE\u7F6E\u6210\u4E86\u201Cend\u201D\uFF0C\u83B7\u53D6\u771F\u5B9EDOM\u8282\u70B9\u7684innerText\u5374\u6CA1\u6709\u5F97\u5230\u9884\u671F\u4E2D\u7684\u201Cend\u201D\uFF0C\u800C\u662F\u5F97\u5230\u4E4B\u524D\u7684\u503C\u201Cbegin\u201D\u5462\uFF1F</p><h2 id="watcher\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#watcher\u961F\u5217" aria-hidden="true">#</a> Watcher\u961F\u5217</h2><p>\u5E26\u7740\u7591\u95EE\uFF0C\u627E\u5230\u4E86Vue.js\u6E90\u7801\u7684Watch\u5B9E\u73B0\u3002\u5F53\u67D0\u4E2A\u54CD\u5E94\u5F0F\u6570\u636E\u53D1\u751F\u53D8\u5316\u7684\u65F6\u5019\uFF0C\u5B83\u7684setter\u51FD\u6570\u4F1A\u901A\u77E5\u95ED\u5305\u4E2D\u7684Dep\uFF0CDep\u5219\u4F1A\u8C03\u7528\u5B83\u7BA1\u7406\u7684\u6240\u6709Watch\u5BF9\u8C61\u3002\u89E6\u53D1Watch\u5BF9\u8C61\u7684update\u5B9E\u73B0\u3002\u6765\u770B\u4E00\u4E0Bupdate\u7684\u5B9E\u73B0\u3002</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*\u540C\u6B65\u5219\u6267\u884Crun\u76F4\u63A5\u6E32\u67D3\u89C6\u56FE*/</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/*\u5F02\u6B65\u63A8\u9001\u5230\u89C2\u5BDF\u8005\u961F\u5217\u4E2D\uFF0C\u4E0B\u4E00\u4E2Atick\u65F6\u8C03\u7528\u3002*/</span>
        <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div>`,8),k=n("\u53D1\u73B0Vue.js\u9ED8\u8BA4\u662F\u4F7F\u7528"),b={href:"https://cn.vuejs.org/v2/guide/reactivity.html#%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E9%98%9F%E5%88%97",target:"_blank",rel:"noopener noreferrer"},m=n("\u5F02\u6B65\u6267\u884CDOM\u66F4\u65B0"),d=n("\u3002 \u5F53\u5F02\u6B65\u6267\u884Cupdate\u7684\u65F6\u5019\uFF0C\u4F1A\u8C03\u7528queueWatcher\u51FD\u6570\u3002"),h=a(`<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">/*\u5C06\u4E00\u4E2A\u89C2\u5BDF\u8005\u5BF9\u8C61push\u8FDB\u89C2\u5BDF\u8005\u961F\u5217\uFF0C\u5728\u961F\u5217\u4E2D\u5DF2\u7ECF\u5B58\u5728\u76F8\u540C\u7684id\u5219\u8BE5\u89C2\u5BDF\u8005\u5BF9\u8C61\u5C06\u88AB\u8DF3\u8FC7\uFF0C\u9664\u975E\u5B83\u662F\u5728\u961F\u5217\u88AB\u5237\u65B0\u65F6\u63A8\u9001*/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">queueWatcher</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">watcher</span><span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*\u83B7\u53D6watcher\u7684id*/</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id
  <span class="token comment">/*\u68C0\u9A8Cid\u662F\u5426\u5B58\u5728\uFF0C\u5DF2\u7ECF\u5B58\u5728\u5219\u76F4\u63A5\u8DF3\u8FC7\uFF0C\u4E0D\u5B58\u5728\u5219\u6807\u8BB0\u54C8\u5E0C\u8868has\uFF0C\u7528\u4E8E\u4E0B\u6B21\u68C0\u9A8C*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/*\u5982\u679C\u6CA1\u6709flush\u6389\uFF0C\u76F4\u63A5push\u5230\u961F\u5217\u4E2D\u5373\u53EF*/</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// if already flushing, splice the watcher based on its id</span>
      <span class="token comment">// if already past its id, it will be run next immediately.</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">&gt;</span> watcher<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span>
      <span class="token punctuation">}</span>
      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// queue the flush</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      waiting <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">nextTick</span><span class="token punctuation">(</span>flushSchedulerQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>\u67E5\u770BqueueWatcher\u7684\u6E90\u7801\u53D1\u73B0\uFF0CWatch\u5BF9\u8C61\u5E76\u4E0D\u662F\u7ACB\u5373\u66F4\u65B0\u89C6\u56FE\uFF0C\u800C\u662F\u88ABpush\u8FDB\u4E86\u4E00\u4E2A\u961F\u5217queue\uFF0C\u6B64\u65F6\u72B6\u6001\u5904\u4E8Ewaiting\u7684\u72B6\u6001\uFF0C\u8FD9\u65F6\u5019\u4F1A\u7EE7\u7EED\u4F1A\u6709Watch\u5BF9\u8C61\u88ABpush\u8FDB\u8FD9\u4E2A\u961F\u5217queue\uFF0C\u7B49\u5230\u4E0B\u4E00\u4E2Atick\u8FD0\u884C\u65F6\uFF0C\u8FD9\u4E9BWatch\u5BF9\u8C61\u624D\u4F1A\u88AB\u904D\u5386\u53D6\u51FA\uFF0C\u66F4\u65B0\u89C6\u56FE\u3002\u540C\u65F6\uFF0Cid\u91CD\u590D\u7684Watcher\u4E0D\u4F1A\u88AB\u591A\u6B21\u52A0\u5165\u5230queue\u4E2D\u53BB\uFF0C\u56E0\u4E3A\u5728\u6700\u7EC8\u6E32\u67D3\u65F6\uFF0C\u53EA\u9700\u8981\u5173\u5FC3\u6570\u636E\u7684\u6700\u7EC8\u7ED3\u679C\u3002</p><p>\u90A3\u4E48\uFF0C\u4EC0\u4E48\u662F\u4E0B\u4E00\u4E2Atick\uFF1F</p><h2 id="nexttick" tabindex="-1"><a class="header-anchor" href="#nexttick" aria-hidden="true">#</a> nextTick</h2>`,4),g=n("vue.js\u63D0\u4F9B\u4E86\u4E00\u4E2A"),w={href:"https://cn.vuejs.org/v2/api/#Vue-nextTick",target:"_blank",rel:"noopener noreferrer"},f=n("nextTick"),v=n("\u51FD\u6570\uFF0C\u5176\u5B9E\u4E5F\u5C31\u662F\u4E0A\u9762\u8C03\u7528\u7684nextTick\u3002"),y=a(`<p>nextTick\u7684\u5B9E\u73B0\u6BD4\u8F83\u7B80\u5355\uFF0C\u6267\u884C\u7684\u76EE\u7684\u662F\u5728microtask\u6216\u8005task\u4E2D\u63A8\u5165\u4E00\u4E2Afunction\uFF0C\u5728\u5F53\u524D\u6808\u6267\u884C\u5B8C\u6BD5\uFF08\u4E5F\u8BB8\u8FD8\u4F1A\u6709\u4E00\u4E9B\u6392\u5728\u524D\u9762\u7684\u9700\u8981\u6267\u884C\u7684\u4EFB\u52A1\uFF09\u4EE5\u540E\u6267\u884CnextTick\u4F20\u5165\u7684function\uFF0C\u770B\u4E00\u4E0B\u6E90\u7801\uFF1A</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token doc-comment comment">/**
 * Defer a task to execute it asynchronously.
 */</span>
 <span class="token comment">/*
    \u5EF6\u8FDF\u4E00\u4E2A\u4EFB\u52A1\u4F7F\u5176\u5F02\u6B65\u6267\u884C\uFF0C\u5728\u4E0B\u4E00\u4E2Atick\u65F6\u6267\u884C\uFF0C\u4E00\u4E2A\u7ACB\u5373\u6267\u884C\u51FD\u6570\uFF0C\u8FD4\u56DE\u4E00\u4E2Afunction
    \u8FD9\u4E2A\u51FD\u6570\u7684\u4F5C\u7528\u662F\u5728task\u6216\u8005microtask\u4E2D\u63A8\u5165\u4E00\u4E2AtimerFunc\uFF0C\u5728\u5F53\u524D\u8C03\u7528\u6808\u6267\u884C\u5B8C\u4EE5\u540E\u4EE5\u6B64\u6267\u884C\u76F4\u5230\u6267\u884C\u5230timerFunc
    \u76EE\u7684\u662F\u5EF6\u8FDF\u5230\u5F53\u524D\u8C03\u7528\u6808\u6267\u884C\u5B8C\u4EE5\u540E\u6267\u884C
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> nextTick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*\u5B58\u653E\u5F02\u6B65\u6267\u884C\u7684\u56DE\u8C03*/</span>
  <span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">/*\u4E00\u4E2A\u6807\u8BB0\u4F4D\uFF0C\u5982\u679C\u5DF2\u7ECF\u6709timerFunc\u88AB\u63A8\u9001\u5230\u4EFB\u52A1\u961F\u5217\u4E2D\u53BB\u5219\u4E0D\u9700\u8981\u91CD\u590D\u63A8\u9001*/</span>
  <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token comment">/*\u4E00\u4E2A\u51FD\u6570\u6307\u9488\uFF0C\u6307\u5411\u51FD\u6570\u5C06\u88AB\u63A8\u9001\u5230\u4EFB\u52A1\u961F\u5217\u4E2D\uFF0C\u7B49\u5230\u4E3B\u7EBF\u7A0B\u4EFB\u52A1\u6267\u884C\u5B8C\u65F6\uFF0C\u4EFB\u52A1\u961F\u5217\u4E2D\u7684timerFunc\u88AB\u8C03\u7528*/</span>
  <span class="token keyword">let</span> timerFunc

  <span class="token comment">/*\u4E0B\u4E00\u4E2Atick\u65F6\u7684\u56DE\u8C03*/</span>
  <span class="token keyword">function</span> <span class="token function">nextTickHandler</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*\u4E00\u4E2A\u6807\u8BB0\u4F4D\uFF0C\u6807\u8BB0\u7B49\u5F85\u72B6\u6001\uFF08\u5373\u51FD\u6570\u5DF2\u7ECF\u88AB\u63A8\u5165\u4EFB\u52A1\u961F\u5217\u6216\u8005\u4E3B\u7EBF\u7A0B\uFF0C\u5DF2\u7ECF\u5728\u7B49\u5F85\u5F53\u524D\u6808\u6267\u884C\u5B8C\u6BD5\u53BB\u6267\u884C\uFF09\uFF0C\u8FD9\u6837\u5C31\u4E0D\u9700\u8981\u5728push\u591A\u4E2A\u56DE\u8C03\u5230callbacks\u65F6\u5C06timerFunc\u591A\u6B21\u63A8\u5165\u4EFB\u52A1\u961F\u5217\u6216\u8005\u4E3B\u7EBF\u7A0B*/</span>
    pending <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">/*\u6267\u884C\u6240\u6709callback*/</span>
    <span class="token keyword">const</span> copies <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    callbacks<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> copies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      copies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// the nextTick behavior leverages the microtask queue, which can be accessed</span>
  <span class="token comment">// via either native Promise.then or MutationObserver.</span>
  <span class="token comment">// MutationObserver has wider support, however it is seriously bugged in</span>
  <span class="token comment">// UIWebView in iOS &gt;= 9.3.3 when triggered in touch event handlers. It</span>
  <span class="token comment">// completely stops working after triggering a few times... so, if native</span>
  <span class="token comment">// Promise is available, we will use it:</span>
  <span class="token comment">/* istanbul ignore if */</span>

  <span class="token comment">/*
    \u8FD9\u91CC\u89E3\u91CA\u4E00\u4E0B\uFF0C\u4E00\u5171\u6709Promise\u3001MutationObserver\u4EE5\u53CAsetTimeout\u4E09\u79CD\u5C1D\u8BD5\u5F97\u5230timerFunc\u7684\u65B9\u6CD5
    \u4F18\u5148\u4F7F\u7528Promise\uFF0C\u5728Promise\u4E0D\u5B58\u5728\u7684\u60C5\u51B5\u4E0B\u4F7F\u7528MutationObserver\uFF0C\u8FD9\u4E24\u4E2A\u65B9\u6CD5\u90FD\u4F1A\u5728microtask\u4E2D\u6267\u884C\uFF0C\u4F1A\u6BD4setTimeout\u66F4\u65E9\u6267\u884C\uFF0C\u6240\u4EE5\u4F18\u5148\u4F7F\u7528\u3002
    \u5982\u679C\u4E0A\u8FF0\u4E24\u79CD\u65B9\u6CD5\u90FD\u4E0D\u652F\u6301\u7684\u73AF\u5883\u5219\u4F1A\u4F7F\u7528setTimeout\uFF0C\u5728task\u5C3E\u90E8\u63A8\u5165\u8FD9\u4E2A\u51FD\u6570\uFF0C\u7B49\u5F85\u8C03\u7528\u6267\u884C\u3002
    \u53C2\u8003\uFF1Ahttps://www.zhihu.com/question/55364497
  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*\u4F7F\u7528Promise*/</span>
    <span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> <span class="token function-variable function">logError</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>nextTickHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>logError<span class="token punctuation">)</span>
      <span class="token comment">// in problematic UIWebViews, Promise.then doesn&#39;t completely break, but</span>
      <span class="token comment">// it can get stuck in a weird state where callbacks are pushed into the</span>
      <span class="token comment">// microtask queue but the queue isn&#39;t being flushed, until the browser</span>
      <span class="token comment">// needs to do some other work, e.g. handle a timer. Therefore we can</span>
      <span class="token comment">// &quot;force&quot; the microtask queue to be flushed by adding an empty timer.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isIOS<span class="token punctuation">)</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> MutationObserver <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
    <span class="token function">isNative</span><span class="token punctuation">(</span>MutationObserver<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// PhantomJS and iOS 7.x</span>
    MutationObserver<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;[object MutationObserverConstructor]&#39;</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// use MutationObserver where native Promise is not available,</span>
    <span class="token comment">// e.g. PhantomJS IE11, iOS7, Android 4.4</span>
    <span class="token comment">/*\u65B0\u5EFA\u4E00\u4E2AtextNode\u7684DOM\u5BF9\u8C61\uFF0C\u7528MutationObserver\u7ED1\u5B9A\u8BE5DOM\u5E76\u6307\u5B9A\u56DE\u8C03\u51FD\u6570\uFF0C\u5728DOM\u53D8\u5316\u7684\u65F6\u5019\u5219\u4F1A\u89E6\u53D1\u56DE\u8C03,\u8BE5\u56DE\u8C03\u4F1A\u8FDB\u5165\u4E3B\u7EBF\u7A0B\uFF08\u6BD4\u4EFB\u52A1\u961F\u5217\u4F18\u5148\u6267\u884C\uFF09\uFF0C\u5373textNode.data = String(counter)\u65F6\u4FBF\u4F1A\u89E6\u53D1\u56DE\u8C03*/</span>
    <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>nextTickHandler<span class="token punctuation">)</span>
    <span class="token keyword">var</span> textNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>textNode<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">characterData</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      counter <span class="token operator">=</span> <span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span>
      textNode<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// fallback to setTimeout</span>
    <span class="token comment">/* istanbul ignore next */</span>
    <span class="token comment">/*\u4F7F\u7528setTimeout\u5C06\u56DE\u8C03\u63A8\u5165\u4EFB\u52A1\u961F\u5217\u5C3E\u90E8*/</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>nextTickHandler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    \u63A8\u9001\u5230\u961F\u5217\u4E2D\u4E0B\u4E00\u4E2Atick\u65F6\u6267\u884C
    cb \u56DE\u8C03\u51FD\u6570
    ctx \u4E0A\u4E0B\u6587
  */</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">queueNextTick</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _resolve
    <span class="token comment">/*cb\u5B58\u5230callbacks\u4E2D*/</span>
    callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token string">&#39;nextTick&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_resolve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pending <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">timerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        _resolve <span class="token operator">=</span> resolve
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br></div></div><p>\u5B83\u662F\u4E00\u4E2A\u7ACB\u5373\u6267\u884C\u51FD\u6570,\u8FD4\u56DE\u4E00\u4E2AqueueNextTick\u63A5\u53E3\u3002</p><p>\u4F20\u5165\u7684cb\u4F1A\u88ABpush\u8FDBcallbacks\u4E2D\u5B58\u653E\u8D77\u6765\uFF0C\u7136\u540E\u6267\u884CtimerFunc\uFF08pending\u662F\u4E00\u4E2A\u72B6\u6001\u6807\u8BB0\uFF0C\u4FDD\u8BC1timerFunc\u5728\u4E0B\u4E00\u4E2Atick\u4E4B\u524D\u53EA\u6267\u884C\u4E00\u6B21\uFF09\u3002</p><p>timerFunc\u662F\u4EC0\u4E48\uFF1F</p><p>\u770B\u4E86\u6E90\u7801\u53D1\u73B0timerFunc\u4F1A\u68C0\u6D4B\u5F53\u524D\u73AF\u5883\u800C\u4E0D\u540C\u5B9E\u73B0\uFF0C\u5176\u5B9E\u5C31\u662F\u6309\u7167Promise\uFF0CMutationObserver\uFF0CsetTimeout\u4F18\u5148\u7EA7\uFF0C\u54EA\u4E2A\u5B58\u5728\u4F7F\u7528\u54EA\u4E2A\uFF0C\u6700\u4E0D\u6D4E\u7684\u73AF\u5883\u4E0B\u4F7F\u7528setTimeout\u3002</p><p>\u8FD9\u91CC\u89E3\u91CA\u4E00\u4E0B\uFF0C\u4E00\u5171\u6709Promise\u3001MutationObserver\u4EE5\u53CAsetTimeout\u4E09\u79CD\u5C1D\u8BD5\u5F97\u5230timerFunc\u7684\u65B9\u6CD5\u3002 \u4F18\u5148\u4F7F\u7528Promise\uFF0C\u5728Promise\u4E0D\u5B58\u5728\u7684\u60C5\u51B5\u4E0B\u4F7F\u7528MutationObserver\uFF0C\u8FD9\u4E24\u4E2A\u65B9\u6CD5\u7684\u56DE\u8C03\u51FD\u6570\u90FD\u4F1A\u5728microtask\u4E2D\u6267\u884C\uFF0C\u5B83\u4EEC\u4F1A\u6BD4setTimeout\u66F4\u65E9\u6267\u884C\uFF0C\u6240\u4EE5\u4F18\u5148\u4F7F\u7528\u3002 \u5982\u679C\u4E0A\u8FF0\u4E24\u79CD\u65B9\u6CD5\u90FD\u4E0D\u652F\u6301\u7684\u73AF\u5883\u5219\u4F1A\u4F7F\u7528setTimeout\uFF0C\u5728task\u5C3E\u90E8\u63A8\u5165\u8FD9\u4E2A\u51FD\u6570\uFF0C\u7B49\u5F85\u8C03\u7528\u6267\u884C\u3002</p><p>\u4E3A\u4EC0\u4E48\u8981\u4F18\u5148\u4F7F\u7528microtask\uFF1F\u5728\u987E\u8F76\u7075\u5728\u77E5\u4E4E\u7684\u56DE\u7B54\u4E2D\u5B66\u4E60\u5230\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>JS \u7684 event loop \u6267\u884C\u65F6\u4F1A\u533A\u5206 task \u548C microtask\uFF0C\u5F15\u64CE\u5728\u6BCF\u4E2A task \u6267\u884C\u5B8C\u6BD5\uFF0C\u4ECE\u961F\u5217\u4E2D\u53D6\u4E0B\u4E00\u4E2A task \u6765\u6267\u884C\u4E4B\u524D\uFF0C\u4F1A\u5148\u6267\u884C\u5B8C\u6240\u6709 microtask \u961F\u5217\u4E2D\u7684 microtask\u3002
setTimeout \u56DE\u8C03\u4F1A\u88AB\u5206\u914D\u5230\u4E00\u4E2A\u65B0\u7684 task \u4E2D\u6267\u884C\uFF0C\u800C Promise \u7684 resolver\u3001MutationObserver \u7684\u56DE\u8C03\u90FD\u4F1A\u88AB\u5B89\u6392\u5230\u4E00\u4E2A\u65B0\u7684 microtask \u4E2D\u6267\u884C\uFF0C\u4F1A\u6BD4 setTimeout \u4EA7\u751F\u7684 task \u5148\u6267\u884C\u3002
\u8981\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684 microtask\uFF0C\u4F18\u5148\u4F7F\u7528 Promise\uFF0C\u5982\u679C\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\uFF0C\u518D\u5C1D\u8BD5 MutationObserver\u3002
\u5B9E\u5728\u4E0D\u884C\uFF0C\u53EA\u80FD\u7528 setTimeout \u521B\u5EFA task \u4E86\u3002
\u4E3A\u5565\u8981\u7528 microtask\uFF1F
\u6839\u636E HTML Standard\uFF0C\u5728\u6BCF\u4E2A task \u8FD0\u884C\u5B8C\u4EE5\u540E\uFF0CUI \u90FD\u4F1A\u91CD\u6E32\u67D3\uFF0C\u90A3\u4E48\u5728 microtask \u4E2D\u5C31\u5B8C\u6210\u6570\u636E\u66F4\u65B0\uFF0C\u5F53\u524D task \u7ED3\u675F\u5C31\u53EF\u4EE5\u5F97\u5230\u6700\u65B0\u7684 UI \u4E86\u3002
\u53CD\u4E4B\u5982\u679C\u65B0\u5EFA\u4E00\u4E2A task \u6765\u505A\u6570\u636E\u66F4\u65B0\uFF0C\u90A3\u4E48\u6E32\u67D3\u5C31\u4F1A\u8FDB\u884C\u4E24\u6B21\u3002

\u53C2\u8003\u987E\u8F76\u7075\u77E5\u4E4E\u7684\u56DE\u7B54\uFF1Ahttps://www.zhihu.com/question/55364497/answer/144215284
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>\u9996\u5148\u662FPromise\uFF0CPromise.resolve().then()\u53EF\u4EE5\u5728microtask\u4E2D\u52A0\u5165\u5B83\u7684\u56DE\u8C03\uFF0C</p><p>MutationObserver\u65B0\u5EFA\u4E00\u4E2AtextNode\u7684DOM\u5BF9\u8C61\uFF0C\u7528MutationObserver\u7ED1\u5B9A\u8BE5DOM\u5E76\u6307\u5B9A\u56DE\u8C03\u51FD\u6570\uFF0C\u5728DOM\u53D8\u5316\u7684\u65F6\u5019\u5219\u4F1A\u89E6\u53D1\u56DE\u8C03,\u8BE5\u56DE\u8C03\u4F1A\u8FDB\u5165microtask\uFF0C\u5373textNode.data = String(counter)\u65F6\u4FBF\u4F1A\u52A0\u5165\u8BE5\u56DE\u8C03\u3002</p><p>setTimeout\u662F\u6700\u540E\u7684\u4E00\u79CD\u5907\u9009\u65B9\u6848\uFF0C\u5B83\u4F1A\u5C06\u56DE\u8C03\u51FD\u6570\u52A0\u5165task\u4E2D\uFF0C\u7B49\u5230\u6267\u884C\u3002</p><p>\u7EFC\u4E0A\uFF0CnextTick\u7684\u76EE\u7684\u5C31\u662F\u4EA7\u751F\u4E00\u4E2A\u56DE\u8C03\u51FD\u6570\u52A0\u5165task\u6216\u8005microtask\u4E2D\uFF0C\u5F53\u524D\u6808\u6267\u884C\u5B8C\u4EE5\u540E\uFF08\u53EF\u80FD\u4E2D\u95F4\u8FD8\u6709\u522B\u7684\u6392\u5728\u524D\u9762\u7684\u51FD\u6570\uFF09\u8C03\u7528\u8BE5\u56DE\u8C03\u51FD\u6570\uFF0C\u8D77\u5230\u4E86\u5F02\u6B65\u89E6\u53D1\uFF08\u5373\u4E0B\u4E00\u4E2Atick\u65F6\u89E6\u53D1\uFF09\u7684\u76EE\u7684\u3002</p><h2 id="flushschedulerqueue" tabindex="-1"><a class="header-anchor" href="#flushschedulerqueue" aria-hidden="true">#</a> flushSchedulerQueue</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*Github:https://github.com/answershuto*/</span>
<span class="token doc-comment comment">/**
 * Flush both queues and run the watchers.
 */</span>
 <span class="token comment">/*nextTick\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u5728\u4E0B\u4E00\u4E2Atick\u65F6flush\u6389\u4E24\u4E2A\u961F\u5217\u540C\u65F6\u8FD0\u884Cwatchers*/</span>
<span class="token keyword">function</span> <span class="token function">flushSchedulerQueue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  flushing <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">let</span> watcher<span class="token punctuation">,</span> id

  <span class="token comment">// Sort queue before flush.</span>
  <span class="token comment">// This ensures that:</span>
  <span class="token comment">// 1. Components are updated from parent to child. (because parent is always</span>
  <span class="token comment">//    created before the child)</span>
  <span class="token comment">// 2. A component&#39;s user watchers are run before its render watcher (because</span>
  <span class="token comment">//    user watchers are created before the render watcher)</span>
  <span class="token comment">// 3. If a component is destroyed during a parent component&#39;s watcher run,</span>
  <span class="token comment">//    its watchers can be skipped.</span>
  <span class="token comment">/*
    \u7ED9queue\u6392\u5E8F\uFF0C\u8FD9\u6837\u505A\u53EF\u4EE5\u4FDD\u8BC1\uFF1A
    1.\u7EC4\u4EF6\u66F4\u65B0\u7684\u987A\u5E8F\u662F\u4ECE\u7236\u7EC4\u4EF6\u5230\u5B50\u7EC4\u4EF6\u7684\u987A\u5E8F\uFF0C\u56E0\u4E3A\u7236\u7EC4\u4EF6\u603B\u662F\u6BD4\u5B50\u7EC4\u4EF6\u5148\u521B\u5EFA\u3002
    2.\u4E00\u4E2A\u7EC4\u4EF6\u7684user watchers\u6BD4render watcher\u5148\u8FD0\u884C\uFF0C\u56E0\u4E3Auser watchers\u5F80\u5F80\u6BD4render watcher\u66F4\u65E9\u521B\u5EFA
    3.\u5982\u679C\u4E00\u4E2A\u7EC4\u4EF6\u5728\u7236\u7EC4\u4EF6watcher\u8FD0\u884C\u671F\u95F4\u88AB\u9500\u6BC1\uFF0C\u5B83\u7684watcher\u6267\u884C\u5C06\u88AB\u8DF3\u8FC7\u3002
  */</span>
  queue<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

  <span class="token comment">// do not cache length because more watchers might be pushed</span>
  <span class="token comment">// as we run existing watchers</span>
  <span class="token comment">/*\u8FD9\u91CC\u4E0D\u7528index = queue.length;index &gt; 0; index--\u7684\u65B9\u5F0F\u5199\u662F\u56E0\u4E3A\u4E0D\u8981\u5C06length\u8FDB\u884C\u7F13\u5B58\uFF0C\u56E0\u4E3A\u5728\u6267\u884C\u5904\u7406\u73B0\u6709watcher\u5BF9\u8C61\u671F\u95F4\uFF0C\u66F4\u591A\u7684watcher\u5BF9\u8C61\u53EF\u80FD\u4F1A\u88ABpush\u8FDBqueue*/</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id
    <span class="token comment">/*\u5C06has\u7684\u6807\u8BB0\u5220\u9664*/</span>
    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">/*\u6267\u884Cwatcher*/</span>
    watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// in dev build, check and stop circular updates.</span>
    <span class="token comment">/*
      \u5728\u6D4B\u8BD5\u73AF\u5883\u4E2D\uFF0C\u68C0\u6D4Bwatch\u662F\u5426\u5728\u6B7B\u5FAA\u73AF\u4E2D
      \u6BD4\u5982\u8FD9\u6837\u4E00\u79CD\u60C5\u51B5
      watch: {
        test () {
          this.test++;
        }
      }
      \u6301\u7EED\u6267\u884C\u4E86\u4E00\u767E\u6B21watch\u4EE3\u8868\u53EF\u80FD\u5B58\u5728\u6B7B\u5FAA\u73AF
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">&amp;&amp;</span> has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_UPDATE_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token string">&#39;You may have an infinite update loop &#39;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>
            watcher<span class="token punctuation">.</span>user
              <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">in watcher with expression &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span>
              <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">in a component render function.</span><span class="token template-punctuation string">\`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          watcher<span class="token punctuation">.</span>vm
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// keep copies of post queues before resetting state</span>
  <span class="token comment">/**/</span>
  <span class="token comment">/*\u5F97\u5230\u961F\u5217\u7684\u62F7\u8D1D*/</span>
  <span class="token keyword">const</span> activatedQueue <span class="token operator">=</span> activatedChildren<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> updatedQueue <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/*\u91CD\u7F6E\u8C03\u5EA6\u8005\u7684\u72B6\u6001*/</span>
  <span class="token function">resetSchedulerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// call component updated and activated hooks</span>
  <span class="token comment">/*\u4F7F\u5B50\u7EC4\u4EF6\u72B6\u6001\u90FD\u6539\u7F16\u6210active\u540C\u65F6\u8C03\u7528activated\u94A9\u5B50*/</span>
  <span class="token function">callActivatedHooks</span><span class="token punctuation">(</span>activatedQueue<span class="token punctuation">)</span>
  <span class="token comment">/*\u8C03\u7528updated\u94A9\u5B50*/</span>
  <span class="token function">callUpdateHooks</span><span class="token punctuation">(</span>updatedQueue<span class="token punctuation">)</span>

  <span class="token comment">// devtool hook</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>devtools <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>devtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    devtools<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;flush&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>flushSchedulerQueue\u662F\u4E0B\u4E00\u4E2Atick\u65F6\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u4E3B\u8981\u76EE\u7684\u662F\u6267\u884CWatcher\u7684run\u51FD\u6570\uFF0C\u7528\u6765\u66F4\u65B0\u89C6\u56FE</p><h2 id="\u4E3A\u4EC0\u4E48\u8981\u5F02\u6B65\u66F4\u65B0\u89C6\u56FE" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u4EC0\u4E48\u8981\u5F02\u6B65\u66F4\u65B0\u89C6\u56FE" aria-hidden="true">#</a> \u4E3A\u4EC0\u4E48\u8981\u5F02\u6B65\u66F4\u65B0\u89C6\u56FE</h2><p>\u6765\u770B\u4E00\u4E0B\u4E0B\u9762\u8FD9\u4E00\u6BB5\u4EE3\u7801</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{{test}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>test<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>\u73B0\u5728\u6709\u8FD9\u6837\u7684\u4E00\u79CD\u60C5\u51B5\uFF0Cmounted\u7684\u65F6\u5019test\u7684\u503C\u4F1A\u88AB++\u5FAA\u73AF\u6267\u884C1000\u6B21\u3002 \u6BCF\u6B21++\u65F6\uFF0C\u90FD\u4F1A\u6839\u636E\u54CD\u5E94\u5F0F\u89E6\u53D1setter-&gt;Dep-&gt;Watcher-&gt;update-&gt;patch\u3002 \u5982\u679C\u8FD9\u65F6\u5019\u6CA1\u6709\u5F02\u6B65\u66F4\u65B0\u89C6\u56FE\uFF0C\u90A3\u4E48\u6BCF\u6B21++\u90FD\u4F1A\u76F4\u63A5\u64CD\u4F5CDOM\u66F4\u65B0\u89C6\u56FE\uFF0C\u8FD9\u662F\u975E\u5E38\u6D88\u8017\u6027\u80FD\u7684\u3002 \u6240\u4EE5Vue.js\u5B9E\u73B0\u4E86\u4E00\u4E2Aqueue\u961F\u5217\uFF0C\u5728\u4E0B\u4E00\u4E2Atick\u7684\u65F6\u5019\u4F1A\u7EDF\u4E00\u6267\u884Cqueue\u4E2DWatcher\u7684run\u3002\u540C\u65F6\uFF0C\u62E5\u6709\u76F8\u540Cid\u7684Watcher\u4E0D\u4F1A\u88AB\u91CD\u590D\u52A0\u5165\u5230\u8BE5queue\u4E2D\u53BB\uFF0C\u6240\u4EE5\u4E0D\u4F1A\u6267\u884C1000\u6B21Watcher\u7684run\u3002\u6700\u7EC8\u66F4\u65B0\u89C6\u56FE\u53EA\u4F1A\u76F4\u63A5\u5C06test\u5BF9\u5E94\u7684DOM\u76840\u53D8\u62101000\u3002 \u4FDD\u8BC1\u66F4\u65B0\u89C6\u56FE\u64CD\u4F5CDOM\u7684\u52A8\u4F5C\u662F\u5728\u5F53\u524D\u6808\u6267\u884C\u5B8C\u4EE5\u540E\u4E0B\u4E00\u4E2Atick\u7684\u65F6\u5019\u8C03\u7528\uFF0C\u5927\u5927\u4F18\u5316\u4E86\u6027\u80FD\u3002</p><h2 id="\u8BBF\u95EE\u771F\u5B9Edom\u8282\u70B9\u66F4\u65B0\u540E\u7684\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#\u8BBF\u95EE\u771F\u5B9Edom\u8282\u70B9\u66F4\u65B0\u540E\u7684\u6570\u636E" aria-hidden="true">#</a> \u8BBF\u95EE\u771F\u5B9EDOM\u8282\u70B9\u66F4\u65B0\u540E\u7684\u6570\u636E</h2><p>\u6240\u4EE5\u9700\u8981\u5728\u4FEE\u6539data\u4E2D\u7684\u6570\u636E\u540E\u8BBF\u95EE\u771F\u5B9E\u7684DOM\u8282\u70B9\u66F4\u65B0\u540E\u7684\u6570\u636E\uFF0C\u53EA\u9700\u8981\u8FD9\u6837\uFF0C\u628A\u6587\u7AE0\u7B2C\u4E00\u4E2A\u4F8B\u5B50\u8FDB\u884C\u4FEE\u6539\u3002</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{test}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleClick<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>tet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token string">&#39;begin&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">methods</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleClick</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token string">&#39;end&#39;</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>test<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6253\u5370&quot;end&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>test<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6253\u5370\u201Cbegin\u201D</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>\u4F7F\u7528Vue.js\u7684global API\u7684$nextTick\u65B9\u6CD5\uFF0C\u5373\u53EF\u5728\u56DE\u8C03\u4E2D\u83B7\u53D6\u5DF2\u7ECF\u66F4\u65B0\u597D\u7684DOM\u5B9E\u4F8B\u4E86\u3002</p>`,26);function x(q,T){const p=e("ExternalLinkIcon");return c(),o(l,null,[i,s("p",null,[k,s("a",b,[m,t(p)]),d]),h,s("p",null,[g,s("a",w,[f,t(p)]),v]),y],64)}var M=u(r,[["render",x]]);export{M as default};
