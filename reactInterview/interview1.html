<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>React 源码解析 | </title><meta name="description" content="君子藏器于身 待时而动 天下有道则见 无道则隐">
    <link rel="modulepreload" href="/technology/assets/app.6f963528.js"><link rel="modulepreload" href="/technology/assets/interview1.html.4e8a496b.js"><link rel="modulepreload" href="/technology/assets/interview1.html.2b23e8a1.js"><link rel="modulepreload" href="/technology/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/technology/assets/style.5f6eabfb.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/technology/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="技术"><span class="title">技术</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="技术"><span class="title">技术</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/technology/base.md" class="" aria-label="技术前瞻"><!--[--><!--]--> 技术前瞻 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="js"><span class="title">js</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="js"><span class="title">js</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillajs/baseObject/symbol.md" class="" aria-label="mozilla：基本对象"><!--[--><!--]--> mozilla：基本对象 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsInterview/baseInterview.md" class="" aria-label="基础面试题"><!--[--><!--]--> 基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/js/stack/executionStack.md" class="" aria-label="js 概念"><!--[--><!--]--> js 概念 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/jsx/support" class="" aria-label="JSX"><!--[--><!--]--> JSX <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/project/inDepthTs.md" class="" aria-label="TypeScript 项目"><!--[--><!--]--> TypeScript 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsNews/es6News.md" class="" aria-label="js 新概念"><!--[--><!--]--> js 新概念 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="css"><span class="title">css</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="css"><span class="title">css</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillaCss/reference/universalSelectors.md" class="" aria-label="第 1 期：CSS API"><!--[--><!--]--> 第 1 期：CSS API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/css/interview/baseCss.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="html"><span class="title">html</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="html"><span class="title">html</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/html/interview/linkImport.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="端"><span class="title">端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="端"><span class="title">端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/browser/interview/baseInterview.md" class="" aria-label="基础浏览器"><!--[--><!--]--> 基础浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/http/interview/baseInterview.md" class="" aria-label="基础http"><!--[--><!--]--> 基础http <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/webpack/interview/webpackInterview.md" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/esbuild/description.md" class="" aria-label="esbuild"><!--[--><!--]--> esbuild <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/rollup/introduction.md" class="" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/git/indx.md" class="" aria-label="git"><!--[--><!--]--> git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/nginx/base.md" class="" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/cli/base.md" class="" aria-label="cli"><!--[--><!--]--> cli <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/npm/commonlyUsed.md" class="" aria-label="npm"><!--[--><!--]--> npm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="react"><span class="title">react</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="react"><span class="title">react</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/ILoveDevelop/react/principle/base.md" class="" aria-label="react 源码阅读 代码视角"><!--[--><!--]--> react 源码阅读 代码视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react/preparation/idea.md" class="" aria-label="react 源码阅读 思想视角"><!--[--><!--]--> react 源码阅读 思想视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react-illustration-series/main/macro-structure.md" class="" aria-label="图解React源码"><!--[--><!--]--> 图解React源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/umi/interview/pluginDva.md" class="" aria-label="umi"><!--[--><!--]--> umi <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/reactInterview/interview1.md" class="" aria-label="整理"><!--[--><!--]--> 整理 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="vue"><span class="title">vue</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="vue"><span class="title">vue</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/vue/prepare/flow.md" class="" aria-label="第 1 期：源码解读-准备工作"><!--[--><!--]--> 第 1 期：源码解读-准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/data-driven/_index.md" class="" aria-label="第2期：源码解读-数据驱动"><!--[--><!--]--> 第2期：源码解读-数据驱动 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/components/create-component.md" class="" aria-label="第3期：源码解读-组件化"><!--[--><!--]--> 第3期：源码解读-组件化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/reactive/reactive-object.md" class="" aria-label="第4期：源码解读-深入响应式原理"><!--[--><!--]--> 第4期：源码解读-深入响应式原理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/compile/entrance.md" class="" aria-label="第5期：源码解读-编译"><!--[--><!--]--> 第5期：源码解读-编译 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/extend/event.md" class="" aria-label="第6期：源码解读-扩展"><!--[--><!--]--> 第6期：源码解读-扩展 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vue-router/install.md" class="" aria-label="第7期：源码解读-VueRouter"><!--[--><!--]--> 第7期：源码解读-VueRouter <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vuex/idex.md" class="" aria-label="第8期：源码解读-Vuex"><!--[--><!--]--> 第8期：源码解读-Vuex <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/interview/baseInterview.md" class="" aria-label="第9期：基础面试题"><!--[--><!--]--> 第9期：基础面试题 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/performance/vue/vue2Base.md" class="" aria-label="vue-性能优化"><!--[--><!--]--> vue-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/react/reactBase.md" class="" aria-label="react-性能优化"><!--[--><!--]--> react-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/base/drag1.md" class="" aria-label="组件设计"><!--[--><!--]--> 组件设计 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/algorithm/interview/baseInterview.md" class="" aria-label="第 1 期：基础面试题"><!--[--><!--]--> 第 1 期：基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/design/overview.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/designFrame/jquery.md" class="" aria-label="设计应用"><!--[--><!--]--> 设计应用 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="技术"><span class="title">技术</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="技术"><span class="title">技术</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/technology/base.md" class="" aria-label="技术前瞻"><!--[--><!--]--> 技术前瞻 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="js"><span class="title">js</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="js"><span class="title">js</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillajs/baseObject/symbol.md" class="" aria-label="mozilla：基本对象"><!--[--><!--]--> mozilla：基本对象 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsInterview/baseInterview.md" class="" aria-label="基础面试题"><!--[--><!--]--> 基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/js/stack/executionStack.md" class="" aria-label="js 概念"><!--[--><!--]--> js 概念 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/jsx/support" class="" aria-label="JSX"><!--[--><!--]--> JSX <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/project/inDepthTs.md" class="" aria-label="TypeScript 项目"><!--[--><!--]--> TypeScript 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsNews/es6News.md" class="" aria-label="js 新概念"><!--[--><!--]--> js 新概念 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="css"><span class="title">css</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="css"><span class="title">css</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillaCss/reference/universalSelectors.md" class="" aria-label="第 1 期：CSS API"><!--[--><!--]--> 第 1 期：CSS API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/css/interview/baseCss.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="html"><span class="title">html</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="html"><span class="title">html</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/html/interview/linkImport.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="端"><span class="title">端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="端"><span class="title">端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/browser/interview/baseInterview.md" class="" aria-label="基础浏览器"><!--[--><!--]--> 基础浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/http/interview/baseInterview.md" class="" aria-label="基础http"><!--[--><!--]--> 基础http <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/webpack/interview/webpackInterview.md" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/esbuild/description.md" class="" aria-label="esbuild"><!--[--><!--]--> esbuild <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/rollup/introduction.md" class="" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/git/indx.md" class="" aria-label="git"><!--[--><!--]--> git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/nginx/base.md" class="" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/cli/base.md" class="" aria-label="cli"><!--[--><!--]--> cli <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/npm/commonlyUsed.md" class="" aria-label="npm"><!--[--><!--]--> npm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="react"><span class="title">react</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="react"><span class="title">react</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/ILoveDevelop/react/principle/base.md" class="" aria-label="react 源码阅读 代码视角"><!--[--><!--]--> react 源码阅读 代码视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react/preparation/idea.md" class="" aria-label="react 源码阅读 思想视角"><!--[--><!--]--> react 源码阅读 思想视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react-illustration-series/main/macro-structure.md" class="" aria-label="图解React源码"><!--[--><!--]--> 图解React源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/umi/interview/pluginDva.md" class="" aria-label="umi"><!--[--><!--]--> umi <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/reactInterview/interview1.md" class="" aria-label="整理"><!--[--><!--]--> 整理 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="vue"><span class="title">vue</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="vue"><span class="title">vue</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/vue/prepare/flow.md" class="" aria-label="第 1 期：源码解读-准备工作"><!--[--><!--]--> 第 1 期：源码解读-准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/data-driven/_index.md" class="" aria-label="第2期：源码解读-数据驱动"><!--[--><!--]--> 第2期：源码解读-数据驱动 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/components/create-component.md" class="" aria-label="第3期：源码解读-组件化"><!--[--><!--]--> 第3期：源码解读-组件化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/reactive/reactive-object.md" class="" aria-label="第4期：源码解读-深入响应式原理"><!--[--><!--]--> 第4期：源码解读-深入响应式原理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/compile/entrance.md" class="" aria-label="第5期：源码解读-编译"><!--[--><!--]--> 第5期：源码解读-编译 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/extend/event.md" class="" aria-label="第6期：源码解读-扩展"><!--[--><!--]--> 第6期：源码解读-扩展 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vue-router/install.md" class="" aria-label="第7期：源码解读-VueRouter"><!--[--><!--]--> 第7期：源码解读-VueRouter <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vuex/idex.md" class="" aria-label="第8期：源码解读-Vuex"><!--[--><!--]--> 第8期：源码解读-Vuex <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/interview/baseInterview.md" class="" aria-label="第9期：基础面试题"><!--[--><!--]--> 第9期：基础面试题 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/performance/vue/vue2Base.md" class="" aria-label="vue-性能优化"><!--[--><!--]--> vue-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/react/reactBase.md" class="" aria-label="react-性能优化"><!--[--><!--]--> react-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/base/drag1.md" class="" aria-label="组件设计"><!--[--><!--]--> 组件设计 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/algorithm/interview/baseInterview.md" class="" aria-label="第 1 期：基础面试题"><!--[--><!--]--> 第 1 期：基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/design/overview.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/designFrame/jquery.md" class="" aria-label="设计应用"><!--[--><!--]--> 设计应用 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">第一期：基础概念笔记 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/reactInterview/inelegantHook.html" class="sidebar-item" aria-label="不优雅的 React Hooks"><!--[--><!--]--> 不优雅的 React Hooks <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="React 源码解析"><!--[--><!--]--> React 源码解析 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/technology/reactInterview/interview1.html#基础概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="基础概念"><!--[--><!--]--> 基础概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html#对象池" class="router-link-active router-link-exact-active sidebar-item" aria-label="对象池"><!--[--><!--]--> 对象池 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html#事务机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="事务机制"><!--[--><!--]--> 事务机制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html#事件分发" class="router-link-active router-link-exact-active sidebar-item" aria-label="事件分发"><!--[--><!--]--> 事件分发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html#生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="生命周期"><!--[--><!--]--> 生命周期 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html#diff-算法" class="router-link-active router-link-exact-active sidebar-item" aria-label="diff 算法"><!--[--><!--]--> diff 算法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/technology/reactInterview/interview1.html#一些其他的点" class="router-link-active router-link-exact-active sidebar-item" aria-label="一些其他的点"><!--[--><!--]--> 一些其他的点 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/technology/reactInterview/interview2.html" class="sidebar-item" aria-label="虚拟DOM和DOM-diff"><!--[--><!--]--> 虚拟DOM和DOM-diff <!--[--><!--]--></a><!----></li><li><a href="/technology/reactInterview/interview3.html" class="sidebar-item" aria-label="useCallback/useMemo"><!--[--><!--]--> useCallback/useMemo <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="react-源码解析" tabindex="-1"><a class="header-anchor" href="#react-源码解析" aria-hidden="true">#</a> React 源码解析</h1><h2 id="基础概念" tabindex="-1"><a class="header-anchor" href="#基础概念" aria-hidden="true">#</a> 基础概念</h2><ul><li><p><strong>ReactElement</strong></p><ul><li><p>数据类，只包含 <code>props</code> <code>refs</code> <code>key</code> 等</p></li><li><p>由 <code>React.creatElement(ReactElement.js)</code> 创建，<code>React.createClass</code> 中 <code>render</code> 中返回的实际也是个 <code>ReactElement</code></p></li></ul></li><li><p><strong>ReactComponent</strong></p><ul><li><p>控制类，包含组件状态，操作方法等</p></li><li><p>包括字符组件、原生 DOM 组件、自定义组件(和空组件)</p></li><li><p>在挂载组件(<code>mountComponent</code>)的时候，会调用到 <code>instantiateReactComponent</code> 方法，利用工厂模式，通过不同的输入返回不同的 <code>component</code></p></li><li><p>代码(<code>instantiateReactComponent.js</code>)：</p></li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> shouldHaveDebugID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> ReactEmptyComponent<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>instantiateReactComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> element <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token comment">// Special case string values</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> ReactHostComponent<span class="token punctuation">.</span><span class="token function">createInternalComponent</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInternalComponentType</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// This is temporarily available for custom components that are not string</span>
            <span class="token comment">// representation, we can drop this code path.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactCompositeComponentWrapper</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> ReactHostComponent<span class="token punctuation">.</span><span class="token function">createInstanceForText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// These two fields are used by the DOM and ART diffing algorithms</span>
    <span class="token comment">// respectively. Instead of using expandos on components, we should be</span>
    <span class="token comment">// storing the state needed by the diffing algorithms elsewhere.</span>
    instance<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>_mountImage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li><p><code>ReactDOMTextComponent</code> 只关心文本，<code>ReactDOMComponent</code> 会稍微简单一些，<code>ReactCompositeComponent</code> 需要关心的最多，包括得到原生 <code>DOM</code> 的渲染内容</p></li><li><p><strong>ReactClass</strong></p><ul><li><p>这个比较特殊，对比 <code>ES5</code> 写法: <code>var MyComponent = React.createClass({})</code>，ES6写法：<code>class MyComponent extends React.Component</code>，为什么用<code>createClass</code>却得到了<code>Component</code>呢？通过源码来看，这两个 <code>api</code> 的实现几乎是一样的，也可以看到，<code>ES6</code> 的写法简洁的多，不用那些<code>getInitialState</code>等特定 <code>api</code>，<code>React</code> 在之后的版本也会抛弃<code>createClass</code>这个 <code>api</code>。并且，在此 <code>api</code> 中，<code>React</code> 进行了<code>autobind</code>。</p></li><li><p>ReactClass.js:</p></li></ul></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> ReactClass <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">createClass</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">spec</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ensure that Constructor.name !== &#39;Constructor&#39;</span>
    <span class="token keyword">var</span> Constructor <span class="token operator">=</span> <span class="token function">identity</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context<span class="token punctuation">,</span> updater</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Wire up auto-binding</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>__reactAutoBindPairs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bindAutoBindMethods</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyObject<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>updater <span class="token operator">=</span> updater <span class="token operator">||</span> ReactNoopUpdateQueue<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// ReactClasses doesn&#39;t have constructors. Instead, they use the</span>
      <span class="token comment">// getInitialState and componentWillMount methods for initialization.</span>
      <span class="token keyword">var</span> initialState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getInitialState <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInitialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> initialState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactClassComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Constructor<span class="token punctuation">;</span>
    <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__reactAutoBindPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    injectedMixins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token function">mixSpecIntoComponent</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> Constructor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mixSpecIntoComponent</span><span class="token punctuation">(</span>Constructor<span class="token punctuation">,</span> spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Initialize the defaultProps property after all mixins have been merged.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Constructor<span class="token punctuation">.</span>getDefaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Constructor<span class="token punctuation">.</span>defaultProps <span class="token operator">=</span> Constructor<span class="token punctuation">.</span><span class="token function">getDefaultProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Reduce time spent doing lookups by setting these on the prototype.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> methodName <span class="token keyword">in</span> ReactClassInterface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Constructor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token function-variable function">ReactClassComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">_assign</span><span class="token punctuation">(</span><span class="token class-name">ReactClassComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token class-name">ReactComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> ReactClassMixin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><ul><li>ReactComponent.js:</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">ReactComponent</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context<span class="token punctuation">,</span> updater</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyObject<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater <span class="token operator">=</span> updater <span class="token operator">||</span> ReactNoopUpdateQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">ReactComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">ReactComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">partialState<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">&#39;setState&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">ReactComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueForceUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">&#39;forceUpdate&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="对象池" tabindex="-1"><a class="header-anchor" href="#对象池" aria-hidden="true">#</a> 对象池</h2><ul><li><p>开辟空间是需要一定代价的</p></li><li><p>如果引用释放而进入 <code>gc</code>，<code>gc</code> 会比较消耗性能和时间，如果内存抖动(大量的对象被创建又在短时间内马上被释放)而频繁 <code>gc</code> 则会影响用户体验</p></li><li><p>既然创建和销毁对象是很耗时的，所以要尽可能减少创建和销毁对象的次数</p></li><li><p>使用时候申请(<code>getPooled</code>)和释放(<code>release</code>)成对出现，使用一个对象后一定要释放还给池子(<code>释放时候要对内部变量置空方便下次使用</code>)</p></li><li><p>代码(<code>PooledClass.js</code>)：</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 只展示部分</span>
<span class="token keyword">var</span> <span class="token function-variable function">oneArgumentPooler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">copyFieldsFrom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> Klass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Klass<span class="token punctuation">.</span>instancePool<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> instance <span class="token operator">=</span> Klass<span class="token punctuation">.</span>instancePool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Klass</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> copyFieldsFrom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Klass</span><span class="token punctuation">(</span>copyFieldsFrom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">standardReleaser</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> Klass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Klass<span class="token punctuation">.</span>instancePool<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> Klass<span class="token punctuation">.</span>poolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Klass<span class="token punctuation">.</span>instancePool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">DEFAULT_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">DEFAULT_POOLER</span> <span class="token operator">=</span> oneArgumentPooler<span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">addPoolingTo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">CopyConstructor<span class="token punctuation">,</span> pooler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Casting as any so that flow ignores the actual implementation and trusts</span>
  <span class="token comment">// it to match the type we declared</span>
  <span class="token keyword">var</span> NewKlass <span class="token operator">=</span> CopyConstructor<span class="token punctuation">;</span>
  NewKlass<span class="token punctuation">.</span>instancePool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  NewKlass<span class="token punctuation">.</span>getPooled <span class="token operator">=</span> pooler <span class="token operator">||</span> <span class="token constant">DEFAULT_POOLER</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NewKlass<span class="token punctuation">.</span>poolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    NewKlass<span class="token punctuation">.</span>poolSize <span class="token operator">=</span> <span class="token constant">DEFAULT_POOL_SIZE</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  NewKlass<span class="token punctuation">.</span>release <span class="token operator">=</span> standardReleaser<span class="token punctuation">;</span>
  <span class="token keyword">return</span> NewKlass<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> PooledClass <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">addPoolingTo</span><span class="token operator">:</span> addPoolingTo<span class="token punctuation">,</span>
  <span class="token literal-property property">oneArgumentPooler</span><span class="token operator">:</span> oneArgumentPooler<span class="token punctuation">,</span>
  <span class="token literal-property property">twoArgumentPooler</span><span class="token operator">:</span> twoArgumentPooler<span class="token punctuation">,</span>
  <span class="token literal-property property">threeArgumentPooler</span><span class="token operator">:</span> threeArgumentPooler<span class="token punctuation">,</span>
  <span class="token literal-property property">fourArgumentPooler</span><span class="token operator">:</span> fourArgumentPooler<span class="token punctuation">,</span>
  <span class="token literal-property property">fiveArgumentPooler</span><span class="token operator">:</span> fiveArgumentPooler
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PooledClass<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><ul><li>使用例子(<code>ReactUpdate.js</code>)：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> transaction <span class="token operator">=</span> ReactUpdatesFlushTransaction<span class="token punctuation">.</span><span class="token function">getPooled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function-variable function">destructor</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirtyComponentsLength <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    CallbackQueue<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>callbackQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbackQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    ReactUpdates<span class="token punctuation">.</span>ReactReconcileTransaction<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reconcileTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reconcileTransaction <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
ReactUpdatesFlushTransaction<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li><p>可以看到，如果短时间内生成了大量的对象占满了池子，后续的对象是不能复用只能新建的</p></li><li><p>对比连接池、线程池：完成任务后并不销毁，而是可以复用去执行其他任务</p></li></ul><h2 id="事务机制" tabindex="-1"><a class="header-anchor" href="#事务机制" aria-hidden="true">#</a> 事务机制</h2><ul><li><p><code>React</code> 通过事务机制来完成一些特定操作，比如 <code>merge state</code>，<code>update component</code></p></li><li><p>示意图(<code>Transaction.js</code>)：</p></li></ul><img src="/technology/assets/react/v2-e1dc82ada4fbbf5c366558532a6f6fca_720w.png" alt="demo"><ul><li>代码(<code>Transaction.js</code>)：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> TransactionImpl <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">perform</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> errorThrown<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_isInTransaction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// Catching errors makes debugging more difficult, so we start with</span>
      <span class="token comment">// errorThrown set to true before setting it to false after calling</span>
      <span class="token comment">// close -- if it&#39;s still set to true in the finally block, it means</span>
      <span class="token comment">// one of these calls threw.</span>
      errorThrown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initializeAll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ret <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorThrown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorThrown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If `method` throws, prefer to show that stack trace over any thrown</span>
          <span class="token comment">// by invoking `closeAll`.</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeAll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Since `method` didn&#39;t throw, we don&#39;t want to silence the exception</span>
          <span class="token comment">// here.</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeAll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isInTransaction <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 执行所有 wrapper 中的 initialize 方法</span>
  <span class="token function-variable function">initializeAll</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">startIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 执行所有 wrapper 中的 close 方法</span>
  <span class="token function-variable function">closeAll</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">startIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> TransactionImpl<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ul><li><p>可以看到和后端的事务是有差异的(有点类似<code>AOP</code>)，虽然都叫<code>transaction</code>，并没有<code>commit</code>，而是自动执行，初始方法没有提供<code>rollback</code>，有二次封装提供的(<code>ReactReconcileTransaction.js</code>)</p></li><li><p>下文会提到事务机制的具体使用场景</p></li></ul><h2 id="事件分发" tabindex="-1"><a class="header-anchor" href="#事件分发" aria-hidden="true">#</a> 事件分发</h2><ul><li>框图(<code>ReactBrowserEventEmitter.js</code>)</li></ul><img src="/technology/assets/react/v2-35d1c1174231dd45f3fda05516ed0239_720w.png" alt="demo"><ul><li><p>组件上声明的事件最终绑定到了 <code>document</code> 上，而不是 <code>React</code> 组件对应的 <code>DOM</code> 节点，这样简化了 <code>DOM</code> 原生事件，减少了内存开销</p></li><li><p>以队列的方式，从触发事件的组件向父组件回溯，调用相应 <code>callback</code>，也就是 <code>React</code> 自身实现了一套事件冒泡机制，虽然 <code>React</code> 对合成事件封装了<code>stopPropagation</code>，但是并不能阻止自己手动绑定的原生事件的冒泡，所以项目中要避免手动绑定原生事件</p></li><li><p>使用对象池来管理合成事件对象的创建和销毁，好处在上文中有描述</p></li><li><p><code>ReactEventListener</code>：负责事件注册和事件分发</p></li><li><p><code>ReactEventEmitter</code>：负责事件执行</p></li><li><p><code>EventPluginHub</code>：负责事件的存储，具体存储在<code>listenerBank</code></p></li><li><p><code>Plugin</code>: 根据不同的事件类型，构造不同的合成事件，可以连接原生事件和组件</p></li><li><p>当事件触发时，会调用<code>ReactEventListener.dispatchEvent</code>，进行分发：找到具体的 <code>ReactComponent</code>，然后向上遍历父组件，实现冒泡</p></li><li><p>代码较多，就不具体分析了，这种统一收集然后分发的思路，可以用在具体项目中</p></li></ul><h2 id="生命周期" tabindex="-1"><a class="header-anchor" href="#生命周期" aria-hidden="true">#</a> 生命周期</h2><ul><li>整体流程:</li></ul><img src="/technology/assets/react/v2-203bfc5510eb197d8117e53f75dbbae5_720w.png" alt="demo"><ul><li><p>主要讲述<code>mount</code>和<code>update</code>，里面也有很多相类似的操作</p></li><li><p><code>componentWillMount</code>，<code>render</code>，<code>componentDidMount</code> 都是在 <code>mountComponent</code> 中被调用</p></li><li><p>分析 <code>ReactCompositeComponent.js</code> 中的<code>mountComponent</code>，发现输出是<code>@return {?string} Rendered markup to be inserted into the DOM</code>.</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">mountComponent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">transaction<span class="token punctuation">,</span> hostParent<span class="token punctuation">,</span> hostContainerInfo<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_mountOrder <span class="token operator">=</span> nextMountID<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_hostParent <span class="token operator">=</span> hostParent<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_hostContainerInfo <span class="token operator">=</span> hostContainerInfo<span class="token punctuation">;</span>
    <span class="token keyword">var</span> publicProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">var</span> publicContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> Component <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">var</span> updateQueue <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Initialize the public class</span>
    <span class="token keyword">var</span> doConstruct <span class="token operator">=</span> <span class="token function">shouldConstruct</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最终会调用 new Component()</span>
    <span class="token keyword">var</span> inst <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_constructComponent</span><span class="token punctuation">(</span>doConstruct<span class="token punctuation">,</span> publicProps<span class="token punctuation">,</span> publicContext<span class="token punctuation">,</span> updateQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> renderedElement<span class="token punctuation">;</span>
    <span class="token comment">// Support functional components</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doConstruct <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> inst<span class="token punctuation">.</span>render <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      renderedElement <span class="token operator">=</span> inst<span class="token punctuation">;</span>
      inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatelessComponent</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_compositeType <span class="token operator">=</span> CompositeTypes<span class="token punctuation">.</span>StatelessFunctional<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 大家经常在用户端用到的 PureComponent，会对 state 进行浅比较然后决定是否执行 render</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPureComponent</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_compositeType <span class="token operator">=</span> CompositeTypes<span class="token punctuation">.</span>PureClass<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_compositeType <span class="token operator">=</span> CompositeTypes<span class="token punctuation">.</span>ImpureClass<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// These should be set up in the constructor, but as a convenience for</span>
    <span class="token comment">// simpler class abstractions, we set them up after the fact.</span>
    inst<span class="token punctuation">.</span>props <span class="token operator">=</span> publicProps<span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span>context <span class="token operator">=</span> publicContext<span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyObject<span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> updateQueue<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_instance <span class="token operator">=</span> inst<span class="token punctuation">;</span>
    <span class="token comment">// Store a reference from the instance back to the internal representation</span>
    <span class="token comment">// 以 element 为 key，存在了 Map 中，之后会用到</span>
    ReactInstanceMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> initialState <span class="token operator">=</span> inst<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialState <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      inst<span class="token punctuation">.</span>state <span class="token operator">=</span> initialState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingStateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingReplaceState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingForceUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> markup<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span>unstable_handleError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      markup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performInitialMountWithErrorHandling</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">,</span> hostParent<span class="token punctuation">,</span> hostContainerInfo<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      markup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">performInitialMount</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">,</span> hostParent<span class="token punctuation">,</span> hostContainerInfo<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       transaction<span class="token punctuation">.</span><span class="token function">getReactMountReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>inst<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> markup<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">shouldConstruct</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><ul><li><p>可以看到，<code>mountComponent</code> 先做实例对象的初始化(<code>props</code>, <code>state</code> 等)，然后调用<code>performInitialMount</code>挂载(<code>performInitialMountWithErrorHandling</code>最终也会调用<code>performInitialMount</code>，只是多了错误处理)，然后调用<code>componentDidMount</code></p></li><li><p><code>transaction.getReactMountReady()</code>会得到<code>CallbackQueue</code>，所以只是加入到队列中，后续执行</p></li><li><p>来看<code>performInitialMount</code>(依然在 <code>ReactCompositeComponent.js</code> 中)</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">performInitialMount</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">renderedElement<span class="token punctuation">,</span> hostParent<span class="token punctuation">,</span> hostContainerInfo<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> inst <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_instance<span class="token punctuation">;</span>
  <span class="token keyword">var</span> debugID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inst<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// When mounting, calls to `setState` by `componentWillMount` will set</span>
    <span class="token comment">// `this._pendingStateQueue` without triggering a re-render.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_pendingStateQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      inst<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processPendingState</span><span class="token punctuation">(</span>inst<span class="token punctuation">.</span>props<span class="token punctuation">,</span> inst<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// If not a stateless component, we now render</span>
  <span class="token comment">// 返回 ReactElement，这也就是上文说的 render 返回 ReactElement</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>renderedElement <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderedElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_renderValidatedComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> nodeType <span class="token operator">=</span> ReactNodeTypes<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedNodeType <span class="token operator">=</span> nodeType<span class="token punctuation">;</span>
  <span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_instantiateReactComponent</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">,</span> nodeType <span class="token operator">!==</span> ReactNodeTypes<span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedComponent <span class="token operator">=</span> child<span class="token punctuation">;</span>
  <span class="token keyword">var</span> markup <span class="token operator">=</span> ReactReconciler<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> hostParent<span class="token punctuation">,</span> hostContainerInfo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processChildContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span> debugID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> markup<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li><p><code>performInitialMount</code> 中先调用<code>componentWillMount</code>，这个过程中 <code>merge state</code>，然后调用<code>_renderValidatedComponent</code>(最终会调用<code>inst.render()</code> )返回 <code>ReactElement</code>，然后调用<code>_instantiateReactComponent</code> 由 <code>ReactElement</code> 创建 <code>ReactComponent</code>，最后进行递归渲染。</p></li><li><p>挂载之后，可以通过<code>setState</code>来更新(机制较为复杂，后文会单独分析)，此过程通过调用<code>updateComponent</code>来完成更新。来看<code>updateComponent</code>(依然在 <code>ReactCompositeComponent.js</code> 中)</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">updateComponent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">transaction<span class="token punctuation">,</span> prevParentElement<span class="token punctuation">,</span> nextParentElement<span class="token punctuation">,</span> prevUnmaskedContext<span class="token punctuation">,</span> nextUnmaskedContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> inst <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_instance<span class="token punctuation">;</span>
  <span class="token keyword">var</span> willReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextContext<span class="token punctuation">;</span>
  <span class="token comment">// context 相关，React 建议少用 context</span>
  <span class="token comment">// Determine if the context has changed or not</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_context <span class="token operator">===</span> nextUnmaskedContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextContext <span class="token operator">=</span> inst<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nextContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processContext</span><span class="token punctuation">(</span>nextUnmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    willReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> prevProps <span class="token operator">=</span> prevParentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextProps <span class="token operator">=</span> nextParentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token comment">// Not a simple state update but a props update</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevParentElement <span class="token operator">!==</span> nextParentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    willReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// An update here will schedule an update but immediately set</span>
  <span class="token comment">// _pendingStateQueue which will ensure that any state updates gets</span>
  <span class="token comment">// immediately reconciled instead of waiting for the next batch.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>willReceive <span class="token operator">&amp;&amp;</span> inst<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inst<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processPendingState</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_pendingForceUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span>shouldComponentUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      shouldUpdate <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositeType <span class="token operator">===</span> CompositeTypes<span class="token punctuation">.</span>PureClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里，就是上文提到的，PureComponent 里的浅比较</span>
        shouldUpdate <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">shallowEqual</span><span class="token punctuation">(</span>inst<span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_updateBatchNumber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingForceUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// Will set `this.props`, `this.state` and `this.context`.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_performComponentUpdate</span><span class="token punctuation">(</span>nextParentElement<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">,</span> nextContext<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> nextUnmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// If it&#39;s determined that a component should not update, we still want</span>
    <span class="token comment">// to set props and state but we shortcut the rest of the update.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextParentElement<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_context <span class="token operator">=</span> nextUnmaskedContext<span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span>props <span class="token operator">=</span> nextProps<span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span>state <span class="token operator">=</span> nextState<span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span>context <span class="token operator">=</span> nextContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><ul><li><code>updateComponent</code>中，先调用<code>componentWillReceiveProps</code>，然后 <code>merge state</code>，然后调用<code>shouldComponentUpdate</code>判断是否需要更新，可以看到，如果组件内部没有自定义，且用的是 <code>PureComponent</code>，会对 <code>state</code> 进行浅比较，设置<code>shouldUpdate</code>，最终调用<code>_performComponentUpdate</code>来进行更新。而在<code>_performComponentUpdate</code>中，会先调用<code>componentWillUpdate</code>，然后调用<code>updateRenderedComponent</code>进行更新，最后调用<code>componentDidUpdate</code>(过程较简单，就不列代码了)。下面看一下<code>updateRenderedComponent</code>的更新机制(依然在 <code>ReactCompositeComponent.js</code> 中)</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">_updateRenderedComponent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">transaction<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> prevComponentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedComponent<span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevRenderedElement <span class="token operator">=</span> prevComponentInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextRenderedElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_renderValidatedComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> debugID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldUpdateReactComponent</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span> nextRenderedElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ReactReconciler<span class="token punctuation">.</span><span class="token function">receiveComponent</span><span class="token punctuation">(</span>prevComponentInstance<span class="token punctuation">,</span> nextRenderedElement<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processChildContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldHostNode <span class="token operator">=</span> ReactReconciler<span class="token punctuation">.</span><span class="token function">getHostNode</span><span class="token punctuation">(</span>prevComponentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactReconciler<span class="token punctuation">.</span><span class="token function">unmountComponent</span><span class="token punctuation">(</span>prevComponentInstance<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> nodeType <span class="token operator">=</span> ReactNodeTypes<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>nextRenderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedNodeType <span class="token operator">=</span> nodeType<span class="token punctuation">;</span>
    <span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_instantiateReactComponent</span><span class="token punctuation">(</span>nextRenderedElement<span class="token punctuation">,</span> nodeType <span class="token operator">!==</span> ReactNodeTypes<span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedComponent <span class="token operator">=</span> child<span class="token punctuation">;</span>
    <span class="token keyword">var</span> nextMarkup <span class="token operator">=</span> ReactReconciler<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_hostParent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_hostContainerInfo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processChildContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span> debugID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_replaceNodeWithMarkup</span><span class="token punctuation">(</span>oldHostNode<span class="token punctuation">,</span> nextMarkup<span class="token punctuation">,</span> prevComponentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可以看到，如果需要更新，则调用<code>ReactReconciler.receiveComponent</code>，会递归更新子组件，否则直接卸载然后挂载。所以，重点是在<code>shouldUpdateReactComponent</code>的判断，<code>React</code> 为了简化 diff，所以有一个假设：<code>在组件层级</code>、<code>type</code>、<code>key 不变的时候</code>，才进行比较更新，否则先 <code>unMount</code> 然后重新 <code>mount</code>。来看<code>shouldUpdateReactComponent(shouldUpdateReactComponent.js)</code> :</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">shouldUpdateReactComponent</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span> nextElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> prevEmpty <span class="token operator">=</span> prevElement <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> prevElement <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextEmpty <span class="token operator">=</span> nextElement <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> nextElement <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevEmpty <span class="token operator">||</span> nextEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> prevEmpty <span class="token operator">===</span> nextEmpty<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span>
  <span class="token comment">// 如果前后两次都为文本元素，则更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果为 ReactDomComponent 或 ReactCompositeComponent，则需要层级 type 和 key 相同，才进行 update（层级在递归中保证相同）</span>
    <span class="token keyword">return</span> nextType <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> prevElement<span class="token punctuation">.</span>key <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>接下来是重头戏：<strong>setState</strong>，上文中已经提到了此 <code>api</code> 为:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>ReactComponent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">&#39;setState&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到这里只是简单的调用<code>enqueueSetState</code>放入队列中，而知道，不可能这么简单的。来看<code>enqueueSetState(ReactUpdateQueue.js中)</code>，<code>this.updater</code>会在 <code>mount</code> 时候赋值为<code>updateQueue</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">enqueueSetState</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">publicInstance<span class="token punctuation">,</span> partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> internalInstance <span class="token operator">=</span> <span class="token function">getInternalInstanceReadyForUpdate</span><span class="token punctuation">(</span>publicInstance<span class="token punctuation">,</span> <span class="token string">&#39;setState&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>internalInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取队列，如果为空则创建</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> internalInstance<span class="token punctuation">.</span>_pendingStateQueue <span class="token operator">||</span> <span class="token punctuation">(</span>internalInstance<span class="token punctuation">.</span>_pendingStateQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将待 merge 的 state 放入队列</span>
  queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将待更新的组件放入队列</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>internalInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">function</span> <span class="token function">getInternalInstanceReadyForUpdate</span><span class="token punctuation">(</span><span class="token parameter">publicInstance<span class="token punctuation">,</span> callerName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 上文提到的以 element 为 key 存入 map，这里可以取到 component</span>
  <span class="token keyword">var</span> internalInstance <span class="token operator">=</span> ReactInstanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>publicInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>internalInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> internalInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>再来看<code>enqueueUpdate(ReactUpdates.js)</code>：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>batchingStrategy<span class="token punctuation">.</span>isBatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    batchingStrategy<span class="token punctuation">.</span><span class="token function">batchedUpdates</span><span class="token punctuation">(</span>enqueueUpdate<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  dirtyComponents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">.</span>_updateBatchNumber <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    component<span class="token punctuation">.</span>_updateBatchNumber <span class="token operator">=</span> updateBatchNumber <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><p>可以看到，如果不处于<code>isBatchingUpdates</code>时，则调用<code>batchingStrategy.batchedUpdates</code>，如果处于的话，则将 <code>component</code> 放入 <code>dirtyComponents</code> 中等待以后处理。这样保证了避免重复 <code>render</code>，因为<code>mountComponent</code>和<code>updateComponent</code> <code>执行的开始，会将isBatchingUpdates</code> 设置为<code>true</code>，之后以事务的方式处理，包括最后时候将<code>isBatchingUpdates</code>置为<code>false</code>。</p></li><li><p>大家一定对 <code>batchingStrategy</code> 和 <code>dirtyComponents</code> 的定义，<code>batchingStrategy</code>由<code>ReactUpdates.injection</code> 注入，而<code>dirtyComponents</code> 是定义在 <code>ReactUpdates.js</code> 中，也就是说二者都为全局的</p></li><li><p>综上，在特定生命周期中，如 <code>getInitialState</code>，<code>componentWillMount</code>，<code>render</code>，<code>componentWillUpdate</code> 中调用<code>setState</code>，并不会引起<code>updateComponent</code>（<code>componentDidMount</code>、<code>componentDidUpdate</code> 中会）。来看<code>batchedUpdates</code>(<code>ReactDefaultBatchingStrategy.js</code>):</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">batchedUpdates</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> alreadyBatchingUpdates <span class="token operator">=</span> ReactDefaultBatchingStrategy<span class="token punctuation">.</span>isBatchingUpdates<span class="token punctuation">;</span>
  ReactDefaultBatchingStrategy<span class="token punctuation">.</span>isBatchingUpdates <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// The code is written this way to avoid extra allocations</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyBatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意这里，上一个代码块中可以看到，当 isBatchingUpdates 为 false 时，callback 为 enqueueUpdate 自身</span>
    <span class="token comment">// 所以即以事务的方式处理</span>
    <span class="token keyword">return</span> transaction<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> transaction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactDefaultBatchingStrategyTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><p>可以看到，当以事务的方式调用进入<code>enqueueUpdate</code>时，<code>isBatchingUpdates</code>已经为<code>true</code>，所以执行<code>dirtyComponents.push(component)</code>;。</p></li><li><p>注意到<code>callback</code>其实就是自身<code>enqueueUpdate</code>，当<code>isBatchingUpdates</code>为<code>false</code>时，也用<code>transaction.perform</code>调用<code>enqueueUpdate</code>，使得结果一样</p></li><li><p>详细介绍事务 <code>transaction</code> 的应用，上文中提到过，事务可以利用<code>wrapper</code>封装，开始和结束时会调用所有 <code>wrapper</code> 的相应方法，来看这两个<code>wrapper</code>: <code>RESET_BATCHED_UPDATES FLUSH_BATCHED_UPDATES</code>(<code>ReactDefaultBatchingStrategy.js</code>):</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token constant">RESET_BATCHED_UPDATES</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">initialize</span><span class="token operator">:</span> emptyFunction<span class="token punctuation">,</span>
  <span class="token function-variable function">close</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ReactDefaultBatchingStrategy<span class="token punctuation">.</span>isBatchingUpdates <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">FLUSH_BATCHED_UPDATES</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">initialize</span><span class="token operator">:</span> emptyFunction<span class="token punctuation">,</span>
  <span class="token literal-property property">close</span><span class="token operator">:</span> ReactUpdates<span class="token punctuation">.</span><span class="token function">flushBatchedUpdates</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>ReactUpdates<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// flushBatchedUpdates 在 ReactUpdates.js 中</span>
<span class="token keyword">var</span> <span class="token function-variable function">flushBatchedUpdates</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ReactUpdatesFlushTransaction&#39;s wrappers will clear the dirtyComponents</span>
  <span class="token comment">// asapEnqueued 为提前执行回调，暂不分析</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>dirtyComponents<span class="token punctuation">.</span>length <span class="token operator">||</span> asapEnqueued<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirtyComponents<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> transaction <span class="token operator">=</span> ReactUpdatesFlushTransaction<span class="token punctuation">.</span><span class="token function">getPooled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      transaction<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ReactUpdatesFlushTransaction<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>asapEnqueued<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li><p>但是，仔细看上面的过程，把组件放入 <code>dirtyComponents</code> 后，事务结束马上就执行 <code>close</code> 方法进行了处理了，和之前理解的流程好像不太一致？这时候再回头看<code>mountComponent</code>和<code>updateComponent</code>，它们的参数：<code>@param {ReactReconcileTransaction} transaction</code>，也就是说整个过程都在<code>ReactReconcileTransaction</code>事务中(事件回调同理)，自然在其中的生命周期调用<code>setState</code>不用引起重复 <code>render</code>，只会将 <code>state</code> 放入队列和将组件放入 <code>dirtyComponents</code> 中，然后在结束后统一处理</p></li><li><p><code>ReactReconcileTransaction</code>中 <code>initialize</code> 用于清空回调队列；<code>close</code> 用于触发回调函数 <code>componentDidMount</code>、<code>componentDidUpdate</code> 执行</p></li><li><p>我开始一直比较疑惑的是<code>ReactDefaultBatchingStrategy.batchedUpdates</code>中的<code>ReactDefaultBatchingStrategyTransaction</code>和<code>ReactReconcileTransaction</code>到底是什么关系？我试图找出两个 <code>transaction</code> 中 <code>wrapper</code> 是否有 <code>merge</code> 的情况，发现没有。目前大概的理解和结论是这样的：<strong>整个生命周期就是一个 <code>transaction</code>，即对应<code>ReactDefaultBatchingStrategy.batchedUpdates</code>，而<code>ReactReconcileTransaction</code>粒度较小，负责单个组件(所以也能看到，前者直接 <code>new</code>，而后者利用了对象池)。通过各自 <code>wrapper</code> 可以看到，前者([<code>FLUSH_BATCHED_UPDATES</code>, <code>RESET_BATCHED_UPDATES</code>])负责了全部组件更新 和 <code>callback</code>，后者([<code>SELECTION_RESTORATION</code>, <code>EVENT_SUPPRESSION</code>, <code>ON_DOM_READY_QUEUEING</code>)负责了各自组件自身的问题，如 <code>focus</code> 等。</strong></p></li><li><p>例证：<code>ReactDom</code> 中调用<code>render</code>(插入过程)，实际最终调用了 <code>ReactMount</code> 的<code>_renderNewRootComponent</code>，其中执行了<code>ReactUpdates.batchedUpdates(batchedMountComponentIntoNode, componentInstance, container, shouldReuseMarkup, context);</code>(注意出现了<code>batchedUpdates</code>)，而<code>batchedMountComponentIntoNode</code>中调用了<code>ReactUpdates.ReactReconcileTransaction.getPooled</code>，这样，嵌套关系就联系起来了</p></li><li><p>例证: <code>ReactEventListener</code> 的<code>dispatchEvent</code>，会调用<code>ReactUpdates.batchedUpdates(handleTopLevelImpl, bookKeeping);</code> 和上述同理</p></li><li><p>熟悉 <code>React</code> 生命周期的同学一定对父子组件各生命周期的执行顺序很清晰(比如 <code>componentWillMount</code> 是从父到子)，以上述的理论，是如何保证的么？上文中可以看到，<code>FLUSH_BATCHED_UPDATES</code>的 <code>close</code>方法利调用了<code>runBatchedUpdates</code>，来看这个方法(<code>ReactUpdates.js</code>):</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">runBatchedUpdates</span><span class="token punctuation">(</span><span class="token parameter">transaction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> len <span class="token operator">=</span> transaction<span class="token punctuation">.</span>dirtyComponentsLength<span class="token punctuation">;</span>
  <span class="token comment">// reconcile them before their children by sorting the array.</span>
  dirtyComponents<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mountOrderComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Any updates enqueued while reconciling must be performed after this entire</span>
  <span class="token comment">// batch. Otherwise, if dirtyComponents is [A, B] where A has children B and</span>
  <span class="token comment">// C, B could update twice in a single batch if C&#39;s render enqueues an update</span>
  <span class="token comment">// to B (since B would have already updated, we should skip it, and the only</span>
  <span class="token comment">// way we can know to do so is by checking the batch counter).</span>
  updateBatchNumber<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If a component is unmounted before pending changes apply, it will still</span>
    <span class="token comment">// be here, but we assume that it has cleared its _pendingCallbacks and</span>
    <span class="token comment">// that was is a noop.</span>
    <span class="token keyword">var</span> component <span class="token operator">=</span> dirtyComponents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// If performUpdateIfNecessary happens to enqueue any new updates, we</span>
    <span class="token comment">// shouldn&#39;t execute the callbacks until the next render happens, so</span>
    <span class="token comment">// stash the callbacks first</span>
    <span class="token keyword">var</span> callbacks <span class="token operator">=</span> component<span class="token punctuation">.</span>_pendingCallbacks<span class="token punctuation">;</span>
    component<span class="token punctuation">.</span>_pendingCallbacks <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    ReactReconciler<span class="token punctuation">.</span><span class="token function">performUpdateIfNecessary</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>reconcileTransaction<span class="token punctuation">,</span> updateBatchNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> callbacks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transaction<span class="token punctuation">.</span>callbackQueue<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getPublicInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">mountOrderComparator</span><span class="token punctuation">(</span><span class="token parameter">c1<span class="token punctuation">,</span> c2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> c1<span class="token punctuation">.</span>_mountOrder <span class="token operator">-</span> c2<span class="token punctuation">.</span>_mountOrder<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li><p><code>flushBatchedUpdates</code>在事务<code>ReactUpdatesFlushTransaction</code>中，此事务是对<code>ReactReconcileTransaction</code>和<code>CallbackQueue</code>的封装，结束时置空 <code>dirtyComponents</code> 并通知回调</p></li><li><p><code>performUpdateIfNecessary</code>最终会调用<code>updateComponent</code>，进行更新</p></li></ul><h2 id="diff-算法" tabindex="-1"><a class="header-anchor" href="#diff-算法" aria-hidden="true">#</a> diff 算法</h2><ul><li><p>传统对于树的 <code>diff</code> 算法，时间复杂度要达到 <code>o(n^3)</code>，这对于用户端显然是不能接受的。而 <code>React</code> 基于几个基础假设，将时间复杂度优化为 <code>o(n)</code></p></li><li><p>假设(策略)</p><ul><li><p><code>Web UI</code> 中 <code>DOM</code> 节点跨层级的移动操作特别少，可以忽略不计</p></li><li><p>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构</p></li><li><p>对于同一层级的一组子节点，它们可以通过唯一 <code>id</code> 进行区分</p></li></ul></li><li><p>场景</p><ul><li><p><code>tree diff</code>: 只对比同层级节点(注意前文中所有代码中，都是只比较<code>prevRenderedElement</code>和<code>nextRenderedElement</code>)</p></li><li><p><code>component diff</code>: 如果类型相同则继续比较，如果类型不同则直接卸载再挂载，即上文中提到的<code>shouldUpdateReactComponent</code>(虽然当两个 <code>component</code> 是不同类型但结构相似时，<code>React diff</code> 会影响性能，但正如 <code>React</code> 官方博客所言：不同类型的 <code>component</code> 是很少存在相似 <code>DOM tree</code> 的机会，因此为这种极端情况而做太多比较是不值得的)</p></li><li><p><code>element diff</code>: 当一组节点处于同一层级时，<code>React</code> 对于每个节点提供了三种操作，分别为<code>INSERT_MARKUP</code>(插入)、 <code>MOVE_EXISTING</code>(移动)、 <code>REMOVE_NODE</code>(删除)</p></li><li><p>上文的代码中，除了关心 type，还关心 key，这也是 diff 算法的关键，如图</p></li></ul><img src="/technology/assets/react/v2-57807dd3d41b61ac6c7b3b3686df381b_720w.png" alt="demo"></li><li><p>首先对新集合的节点进行循环遍历，<code>for (name in nextChildren)</code>，如果存在相同节点，则进行操作，是否移动是通过比较 <code>child._mountIndex &lt; lastIndex</code>，符合则进行节点移动操作(即在老集合中的位置和 <code>lastIndex</code> 比较)，<code>lastIndex</code> 表示访问过的节点在老集合中最右的位置（即最大的位置）。这是一种顺序优化手段，<code>lastIndex</code> 一直在更新，表示访问过的节点在老集合中最右的位置，如果新集合中当前访问的节点比 <code>lastIndex</code> 大，说明当前访问节点在老集合中就比上一个节点位置靠后，则该节点不会影响其他节点的位置，因此不用添加到差异队列中，即不执行移动操作，只有当访问的节点比 <code>lastIndex</code> 小时，才需要进行移动操作。来看具体过程：</p><ul><li><p>从新集合中取得 <code>B</code>，判断老集合中存在相同节点 <code>B</code>，通过对比节点位置判断是否进行移动操作，<code>B</code> 在老集合中的位置 <code>B._mountIndex = 1</code>，此时 <code>lastIndex = 0</code>，不满足 <code>child._mountIndex &lt; lastIndex</code> 的条件，因此不对 <code>B</code> 进行移动操作；更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，其中 <code>prevChild._mountIndex</code> 表示 <code>B</code> 在老集合中的位置，则 <code>lastIndex ＝ 1</code>，并将 <code>B</code> 的位置更新为新集合中的位置<code>prevChild._mountIndex = nextIndex</code>，此时新集合中 <code>B._mountIndex = 0</code>，<code>nextIndex++</code> 进入下一个节点的判断</p></li><li><p>从新集合中取得 <code>A</code>，判断老集合中存在相同节点 <code>A</code>，通过对比节点位置判断是否进行移动操作，<code>A</code> 在老集合中的位置 <code>A._mountIndex = 0</code>，此时 <code>lastIndex = 1</code>，满足 <code>child._mountIndex &lt; lastIndex</code>的条件，因此对 <code>A</code> 进行移动操作 <code>enqueueMove(this, child._mountIndex, toIndex)</code>，其中 <code>toIndex</code> 其实就是 <code>x</code>，表示 <code>A</code> 需要移动到的位置；更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，则 <code>lastIndex ＝ 1</code>，并将 <code>A</code> 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中<code>A._mountIndex = 1</code>，<code>nextIndex++</code> 进入下一个节点的判断。</p></li><li><p>从新集合中取得 <code>D</code>，判断老集合中存在相同节点 <code>D</code>，通过对比节点位置判断是否进行移动操作，<code>D</code> 在老集合中的位置 <code>D._mountIndex = 3</code>，此时 <code>lastIndex = 1</code>，不满足 <code>child._mountIndex &lt; lastIndex</code>的条件，因此不对 <code>D</code> 进行移动操作；更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，则 <code>lastIndex ＝ 3</code>，并将 <code>D</code> 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中<code>D._mountIndex = 2</code>，<code>nextIndex++</code> 进入下一个节点的判断。</p></li><li><p>从新集合中取得 <code>C</code>，判断老集合中存在相同节点 <code>C</code>，通过对比节点位置判断是否进行移动操作，<code>C</code> 在老集合中的位置 <code>C._mountIndex = 2</code>，此时 <code>lastIndex = 3</code>，满足 <code>child._mountIndex &lt; lastIndex</code> 的条件，因此对 <code>C</code> 进行移动操作 <code>enqueueMove(this, child._mountIndex, toIndex)；</code>更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，则 <code>lastIndex ＝ 3</code>，并将 <code>C</code> 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中 <code>C._mountIndex = 3</code>，<code>nextIndex++</code> 进入下一个节点的判断，由于 <code>C</code> 已经是最后一个节点，因此 <code>diff</code> 到此完成。</p></li><li><p>当有新的 <code>Component</code> 插入时，逻辑一致，不做具体分析了</p></li><li><p>当完成集合中所有节点 <code>diff</code>，还需要遍历老集合，如果存在新集合中没有但老集合中有的节点，则删除</p></li></ul></li><li><p>代码(<code>ReactMultiChild.js</code>)，针对 <code>element diff</code>(<code>tree diff</code> 和 <code>component diff</code> 在之前的代码中已经提到过)：</p></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">_updateChildren</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">nextNestedChildrenElements<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> prevChildren <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildren<span class="token punctuation">;</span>
  <span class="token keyword">var</span> removedNodes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> mountImages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextChildren <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_reconcilerUpdateChildren</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">,</span> nextNestedChildrenElements<span class="token punctuation">,</span> mountImages<span class="token punctuation">,</span> removedNodes<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextChildren <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>prevChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> updates <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> name<span class="token punctuation">;</span>
  <span class="token comment">// `nextIndex` will increment for each child in `nextChildren`, but</span>
  <span class="token comment">// `lastIndex` will be the last index visited in `prevChildren`.</span>
  <span class="token keyword">var</span> nextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// `nextMountIndex` will increment for each newly mounted child.</span>
  <span class="token keyword">var</span> nextMountIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lastPlacedNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> nextChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextChildren<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> prevChild <span class="token operator">=</span> prevChildren <span class="token operator">&amp;&amp;</span> prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild <span class="token operator">===</span> nextChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      updates <span class="token operator">=</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">moveChild</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> lastPlacedNode<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      prevChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Update `lastIndex` before `_mountIndex` gets unset by unmounting.</span>
        lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The `removedNodes` loop below will actually remove the child.</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// The child must be instantiated before it&#39;s mounted.</span>
      updates <span class="token operator">=</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_mountChildAtIndex</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">,</span> mountImages<span class="token punctuation">[</span>nextMountIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> lastPlacedNode<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextMountIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
    lastPlacedNode <span class="token operator">=</span> ReactReconciler<span class="token punctuation">.</span><span class="token function">getHostNode</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Remove children that are no longer present.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> removedNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>removedNodes<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      updates <span class="token operator">=</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>updates<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_unmountChild</span><span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> removedNodes<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> updates<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildren <span class="token operator">=</span> nextChildren<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h2 id="一些其他的点" tabindex="-1"><a class="header-anchor" href="#一些其他的点" aria-hidden="true">#</a> 一些其他的点</h2><p>interface(ReactClass.js)</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> ReactClassInterface <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mixins</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">statics</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">propTypes</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">contextTypes</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">childContextTypes</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// ==== Definition methods ====</span>
  <span class="token literal-property property">getDefaultProps</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY_MERGED&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">getInitialState</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY_MERGED&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">getChildContext</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY_MERGED&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_ONCE&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// ==== Delegate methods ====</span>
  <span class="token literal-property property">componentWillMount</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentDidMount</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentWillReceiveProps</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shouldComponentUpdate</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_ONCE&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentWillUpdate</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentDidUpdate</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentWillUnmount</span><span class="token operator">:</span> <span class="token string">&#39;DEFINE_MANY&#39;</span><span class="token punctuation">,</span>
  <span class="token comment">// ==== Advanced methods ====</span>
  <span class="token literal-property property">updateComponent</span><span class="token operator">:</span> <span class="token string">&#39;OVERRIDE_BASE&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">validateMethodOverride</span><span class="token punctuation">(</span><span class="token parameter">isAlreadyDefined<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> specPolicy <span class="token operator">=</span> ReactClassInterface<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">?</span> ReactClassInterface<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// Disallow overriding of base class methods unless explicitly allowed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ReactClassMixin<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>specPolicy <span class="token operator">===</span> <span class="token string">&#39;OVERRIDE_BASE&#39;</span><span class="token punctuation">)</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&#39;ReactClassInterface: You are attempting to override `%s` from your class specification. Ensure that your method names do not overlap with React methods.&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_prodInvariant</span><span class="token punctuation">(</span><span class="token string">&#39;73&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Disallow defining methods more than once unless explicitly allowed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isAlreadyDefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>specPolicy <span class="token operator">===</span> <span class="token string">&#39;DEFINE_MANY&#39;</span> <span class="token operator">||</span> specPolicy <span class="token operator">===</span> <span class="token string">&#39;DEFINE_MANY_MERGED&#39;</span><span class="token punctuation">)</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">?</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&#39;ReactClassInterface: You are attempting to define `%s` on your component more than once. This conflict may be due to a mixin.&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_prodInvariant</span><span class="token punctuation">(</span><span class="token string">&#39;74&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>可以看到，和后端中<code>interface</code>(或是抽象类)还是有区别的，但是可以起到规范和检查的作用，实际项目中可以借鉴</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: dean@57blocks.com">DeanSui</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/technology/reactInterview/inelegantHook.html" class="" aria-label="不优雅的 React Hooks"><!--[--><!--]--> 不优雅的 React Hooks <!--[--><!--]--></a></span><span class="next"><a href="/technology/reactInterview/interview2.html" class="" aria-label="虚拟DOM和DOM-diff"><!--[--><!--]--> 虚拟DOM和DOM-diff <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/technology/assets/app.6f963528.js" defer></script>
  </body>
</html>
