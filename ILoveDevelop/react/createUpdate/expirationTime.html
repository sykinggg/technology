<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title></title><meta name="description" content="君子藏器于身 待时而动 天下有道则见 无道则隐">
    <link rel="modulepreload" href="/technology/assets/app.ba47fc91.js"><link rel="modulepreload" href="/technology/assets/expirationTime.html.d2d4eb2b.js"><link rel="modulepreload" href="/technology/assets/expirationTime.html.735be5a5.js"><link rel="modulepreload" href="/technology/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/technology/assets/style.5f6eabfb.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/technology/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="技术"><span class="title">技术</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="技术"><span class="title">技术</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/technology/base.md" class="" aria-label="技术前瞻"><!--[--><!--]--> 技术前瞻 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="js"><span class="title">js</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="js"><span class="title">js</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillajs/baseObject/symbol.md" class="" aria-label="mozilla：基本对象"><!--[--><!--]--> mozilla：基本对象 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsInterview/baseInterview.md" class="" aria-label="基础面试题"><!--[--><!--]--> 基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/js/stack/executionStack.md" class="" aria-label="js 概念"><!--[--><!--]--> js 概念 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/jsx/support" class="" aria-label="JSX"><!--[--><!--]--> JSX <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/project/inDepthTs.md" class="" aria-label="TypeScript 项目"><!--[--><!--]--> TypeScript 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsNews/es6News.md" class="" aria-label="js 新概念"><!--[--><!--]--> js 新概念 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="css"><span class="title">css</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="css"><span class="title">css</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillaCss/reference/universalSelectors.md" class="" aria-label="第 1 期：CSS API"><!--[--><!--]--> 第 1 期：CSS API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/css/interview/baseCss.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="html"><span class="title">html</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="html"><span class="title">html</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/html/interview/linkImport.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="端"><span class="title">端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="端"><span class="title">端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/browser/interview/baseInterview.md" class="" aria-label="基础浏览器"><!--[--><!--]--> 基础浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/http/interview/baseInterview.md" class="" aria-label="基础http"><!--[--><!--]--> 基础http <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/webpack/interview/webpackInterview.md" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/esbuild/description.md" class="" aria-label="esbuild"><!--[--><!--]--> esbuild <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/rollup/introduction.md" class="" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/git/indx.md" class="" aria-label="git"><!--[--><!--]--> git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/nginx/base.md" class="" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/cli/base.md" class="" aria-label="cli"><!--[--><!--]--> cli <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/npm/commonlyUsed.md" class="" aria-label="npm"><!--[--><!--]--> npm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="react"><span class="title">react</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="react"><span class="title">react</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/ILoveDevelop/react/principle/base.md" class="" aria-label="react 源码阅读 代码视角"><!--[--><!--]--> react 源码阅读 代码视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react/preparation/idea.md" class="" aria-label="react 源码阅读 思想视角"><!--[--><!--]--> react 源码阅读 思想视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react-illustration-series/main/macro-structure.md" class="" aria-label="图解React源码"><!--[--><!--]--> 图解React源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/umi/interview/pluginDva.md" class="" aria-label="umi"><!--[--><!--]--> umi <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/reactInterview/interview1.md" class="" aria-label="整理"><!--[--><!--]--> 整理 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="vue"><span class="title">vue</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="vue"><span class="title">vue</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/vue/prepare/flow.md" class="" aria-label="第 1 期：源码解读-准备工作"><!--[--><!--]--> 第 1 期：源码解读-准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/data-driven/_index.md" class="" aria-label="第2期：源码解读-数据驱动"><!--[--><!--]--> 第2期：源码解读-数据驱动 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/components/create-component.md" class="" aria-label="第3期：源码解读-组件化"><!--[--><!--]--> 第3期：源码解读-组件化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/reactive/reactive-object.md" class="" aria-label="第4期：源码解读-深入响应式原理"><!--[--><!--]--> 第4期：源码解读-深入响应式原理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/compile/entrance.md" class="" aria-label="第5期：源码解读-编译"><!--[--><!--]--> 第5期：源码解读-编译 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/extend/event.md" class="" aria-label="第6期：源码解读-扩展"><!--[--><!--]--> 第6期：源码解读-扩展 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vue-router/install.md" class="" aria-label="第7期：源码解读-VueRouter"><!--[--><!--]--> 第7期：源码解读-VueRouter <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vuex/idex.md" class="" aria-label="第8期：源码解读-Vuex"><!--[--><!--]--> 第8期：源码解读-Vuex <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/interview/baseInterview.md" class="" aria-label="第9期：基础面试题"><!--[--><!--]--> 第9期：基础面试题 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/performance/vue/vue2Base.md" class="" aria-label="vue-性能优化"><!--[--><!--]--> vue-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/react/reactBase.md" class="" aria-label="react-性能优化"><!--[--><!--]--> react-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/base/drag1.md" class="" aria-label="组件设计"><!--[--><!--]--> 组件设计 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/algorithm/interview/baseInterview.md" class="" aria-label="第 1 期：基础面试题"><!--[--><!--]--> 第 1 期：基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/design/overview.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/designFrame/jquery.md" class="" aria-label="设计应用"><!--[--><!--]--> 设计应用 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="技术"><span class="title">技术</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="技术"><span class="title">技术</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/technology/base.md" class="" aria-label="技术前瞻"><!--[--><!--]--> 技术前瞻 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="js"><span class="title">js</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="js"><span class="title">js</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillajs/baseObject/symbol.md" class="" aria-label="mozilla：基本对象"><!--[--><!--]--> mozilla：基本对象 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsInterview/baseInterview.md" class="" aria-label="基础面试题"><!--[--><!--]--> 基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/js/stack/executionStack.md" class="" aria-label="js 概念"><!--[--><!--]--> js 概念 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/jsx/support" class="" aria-label="JSX"><!--[--><!--]--> JSX <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/ts/project/inDepthTs.md" class="" aria-label="TypeScript 项目"><!--[--><!--]--> TypeScript 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/jsNews/es6News.md" class="" aria-label="js 新概念"><!--[--><!--]--> js 新概念 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="css"><span class="title">css</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="css"><span class="title">css</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/mozillaCss/reference/universalSelectors.md" class="" aria-label="第 1 期：CSS API"><!--[--><!--]--> 第 1 期：CSS API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/css/interview/baseCss.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="html"><span class="title">html</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="html"><span class="title">html</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/html/interview/linkImport.md" class="" aria-label="零散记录"><!--[--><!--]--> 零散记录 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="端"><span class="title">端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="端"><span class="title">端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/browser/interview/baseInterview.md" class="" aria-label="基础浏览器"><!--[--><!--]--> 基础浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/http/interview/baseInterview.md" class="" aria-label="基础http"><!--[--><!--]--> 基础http <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="工具"><span class="title">工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="工具"><span class="title">工具</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/webpack/interview/webpackInterview.md" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/esbuild/description.md" class="" aria-label="esbuild"><!--[--><!--]--> esbuild <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/rollup/introduction.md" class="" aria-label="rollup"><!--[--><!--]--> rollup <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/git/indx.md" class="" aria-label="git"><!--[--><!--]--> git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/nginx/base.md" class="" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/cli/base.md" class="" aria-label="cli"><!--[--><!--]--> cli <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/npm/commonlyUsed.md" class="" aria-label="npm"><!--[--><!--]--> npm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="react"><span class="title">react</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="react"><span class="title">react</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/ILoveDevelop/react/principle/base.md" class="" aria-label="react 源码阅读 代码视角"><!--[--><!--]--> react 源码阅读 代码视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react/preparation/idea.md" class="" aria-label="react 源码阅读 思想视角"><!--[--><!--]--> react 源码阅读 思想视角 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/react-illustration-series/main/macro-structure.md" class="" aria-label="图解React源码"><!--[--><!--]--> 图解React源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/umi/interview/pluginDva.md" class="" aria-label="umi"><!--[--><!--]--> umi <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/reactInterview/interview1.md" class="" aria-label="整理"><!--[--><!--]--> 整理 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="vue"><span class="title">vue</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="vue"><span class="title">vue</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/vue/prepare/flow.md" class="" aria-label="第 1 期：源码解读-准备工作"><!--[--><!--]--> 第 1 期：源码解读-准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/data-driven/_index.md" class="" aria-label="第2期：源码解读-数据驱动"><!--[--><!--]--> 第2期：源码解读-数据驱动 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/components/create-component.md" class="" aria-label="第3期：源码解读-组件化"><!--[--><!--]--> 第3期：源码解读-组件化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/reactive/reactive-object.md" class="" aria-label="第4期：源码解读-深入响应式原理"><!--[--><!--]--> 第4期：源码解读-深入响应式原理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/compile/entrance.md" class="" aria-label="第5期：源码解读-编译"><!--[--><!--]--> 第5期：源码解读-编译 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/extend/event.md" class="" aria-label="第6期：源码解读-扩展"><!--[--><!--]--> 第6期：源码解读-扩展 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vue-router/install.md" class="" aria-label="第7期：源码解读-VueRouter"><!--[--><!--]--> 第7期：源码解读-VueRouter <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/vuex/idex.md" class="" aria-label="第8期：源码解读-Vuex"><!--[--><!--]--> 第8期：源码解读-Vuex <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/vue/interview/baseInterview.md" class="" aria-label="第9期：基础面试题"><!--[--><!--]--> 第9期：基础面试题 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="性能优化"><span class="title">性能优化</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/performance/vue/vue2Base.md" class="" aria-label="vue-性能优化"><!--[--><!--]--> vue-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/react/reactBase.md" class="" aria-label="react-性能优化"><!--[--><!--]--> react-性能优化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/performance/base/drag1.md" class="" aria-label="组件设计"><!--[--><!--]--> 组件设计 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="算法&amp;设计"><span class="title">算法&amp;设计</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/technology/algorithm/interview/baseInterview.md" class="" aria-label="第 1 期：基础面试题"><!--[--><!--]--> 第 1 期：基础面试题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/design/overview.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/technology/designFrame/jquery.md" class="" aria-label="设计应用"><!--[--><!--]--> 设计应用 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">概念 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/principle/base.md" class="sidebar-item" aria-label="基础"><!--[--><!--]--> 基础 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/principle/renderProcess.md" class="sidebar-item" aria-label="流程"><!--[--><!--]--> 流程 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/principle/schedulingPrinciple.md" class="sidebar-item" aria-label="调度"><!--[--><!--]--> 调度 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/principle/componentUpdate.md" class="sidebar-item" aria-label="组件更新"><!--[--><!--]--> 组件更新 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/principle/commpontDiff.md" class="sidebar-item" aria-label="diff策略"><!--[--><!--]--> diff策略 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">基础 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/basic/reactApi.md" class="sidebar-item" aria-label="reactapi"><!--[--><!--]--> reactapi <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/basic/reactElement.md" class="sidebar-item" aria-label="ReactElementapi"><!--[--><!--]--> ReactElementapi <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/basic/reactChildren.md" class="sidebar-item" aria-label="ReactChildrenapi"><!--[--><!--]--> ReactChildrenapi <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/basic/reactFiber.md" class="sidebar-item" aria-label="React中的数据结构"><!--[--><!--]--> React中的数据结构 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">创建更新 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/createUpdate/reactDomRender.md" class="sidebar-item" aria-label="ReactDOM.render"><!--[--><!--]--> ReactDOM.render <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/createUpdate/setStateForceUpdate.md" class="sidebar-item" aria-label="setState&amp;forceUpdate"><!--[--><!--]--> setState&amp;forceUpdate <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/createUpdate/expirationTime.md" class="sidebar-item active" aria-label="expirationTime时间"><!--[--><!--]--> expirationTime时间 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">任务调度 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/taskScheduling/globalVariable.md" class="sidebar-item" aria-label="全局变量"><!--[--><!--]--> 全局变量 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/scheduleWork.md" class="sidebar-item" aria-label="scheduleWork"><!--[--><!--]--> scheduleWork <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/reactScheduler.md" class="sidebar-item" aria-label="reactScheduler"><!--[--><!--]--> reactScheduler <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/performWork.md" class="sidebar-item" aria-label="performWork"><!--[--><!--]--> performWork <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/performUnitOfWork.md" class="sidebar-item" aria-label="performUnitOfWork"><!--[--><!--]--> performUnitOfWork <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/renderRoot.md" class="sidebar-item" aria-label="renderRoot"><!--[--><!--]--> renderRoot <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/throwException.md" class="sidebar-item" aria-label="throwException"><!--[--><!--]--> throwException <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/beginWork.md" class="sidebar-item" aria-label="beginWork"><!--[--><!--]--> beginWork <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/mountIndeterminateComponent.md" class="sidebar-item" aria-label="mountIndeterminateComponent"><!--[--><!--]--> mountIndeterminateComponent <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/mountLazyCompont.md" class="sidebar-item" aria-label="mountLazyCompont"><!--[--><!--]--> mountLazyCompont <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateFunctionalComponent.md" class="sidebar-item" aria-label="updateFunctionalComponent"><!--[--><!--]--> updateFunctionalComponent <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateClassComponent.md" class="sidebar-item" aria-label="updateClassComponent"><!--[--><!--]--> updateClassComponent <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateHostRoot.md" class="sidebar-item" aria-label="updateHostRoot"><!--[--><!--]--> updateHostRoot <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateHostComponent.md" class="sidebar-item" aria-label="updateHostComponent"><!--[--><!--]--> updateHostComponent <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateHostText.md" class="sidebar-item" aria-label="updateHostText"><!--[--><!--]--> updateHostText <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateSuspenseComponent.md" class="sidebar-item" aria-label="updateSuspenseComponent"><!--[--><!--]--> updateSuspenseComponent <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updatePortalComponent.md" class="sidebar-item" aria-label="updatePortalComponent"><!--[--><!--]--> updatePortalComponent <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateForwardRef.md" class="sidebar-item" aria-label="updateForwardRef"><!--[--><!--]--> updateForwardRef <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateFragment.md" class="sidebar-item" aria-label="updateFragment"><!--[--><!--]--> updateFragment <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateMode.md" class="sidebar-item" aria-label="updateMode"><!--[--><!--]--> updateMode <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateProfiler.md" class="sidebar-item" aria-label="updateProfiler"><!--[--><!--]--> updateProfiler <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateContextProvider.md" class="sidebar-item" aria-label="updateContextProvider"><!--[--><!--]--> updateContextProvider <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/updateContextConsumer.md" class="sidebar-item" aria-label="updateContextConsumer"><!--[--><!--]--> updateContextConsumer <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/reconcileChildren.md" class="sidebar-item" aria-label="reconcileChildren"><!--[--><!--]--> reconcileChildren <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/reconcileSingleElement.md" class="sidebar-item" aria-label="reconcileSingleElement"><!--[--><!--]--> reconcileSingleElement <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/taskScheduling/reconcileChildrenArray.md" class="sidebar-item" aria-label="reconcileChildrenArray"><!--[--><!--]--> reconcileChildrenArray <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">commit 阶段 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/commit/commitRoot.md" class="sidebar-item" aria-label="commitRoot"><!--[--><!--]--> commitRoot <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/invokeGuardedCallback.md" class="sidebar-item" aria-label="invokeGuardedCallback"><!--[--><!--]--> invokeGuardedCallback <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/commitBeforeMutationLifecycles.md" class="sidebar-item" aria-label="commitBeforeMutationLifecycles"><!--[--><!--]--> commitBeforeMutationLifecycles <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/commitAllHostEffects.md" class="sidebar-item" aria-label="commitAllHostEffects"><!--[--><!--]--> commitAllHostEffects <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/commitPlacement.md" class="sidebar-item" aria-label="commitPlacement"><!--[--><!--]--> commitPlacement <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/commitWork.md" class="sidebar-item" aria-label="commitWork"><!--[--><!--]--> commitWork <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/commitDeletion.md" class="sidebar-item" aria-label="commitDeletion"><!--[--><!--]--> commitDeletion <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/commit/commitAllLifeCycles.md" class="sidebar-item" aria-label="commitAllLifeCycles"><!--[--><!--]--> commitAllLifeCycles <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">功能 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/features/context.md" class="sidebar-item" aria-label="context"><!--[--><!--]--> context <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/hydrate.md" class="sidebar-item" aria-label="hydrate"><!--[--><!--]--> hydrate <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/ref.md" class="sidebar-item" aria-label="ref"><!--[--><!--]--> ref <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/evenInit.md" class="sidebar-item" aria-label="事件系统初始化"><!--[--><!--]--> 事件系统初始化 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/eventBind.md" class="sidebar-item" aria-label="事件绑定"><!--[--><!--]--> 事件绑定 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/eventDispath.md" class="sidebar-item" aria-label="事件触发"><!--[--><!--]--> 事件触发 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/eventCreateEventObject.md" class="sidebar-item" aria-label="事件对象生成"><!--[--><!--]--> 事件对象生成 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/suspense.md" class="sidebar-item" aria-label="suspense"><!--[--><!--]--> suspense <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/suspenseWork.md" class="sidebar-item" aria-label="挂起任务"><!--[--><!--]--> 挂起任务 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/features/suspenseLazy.md" class="sidebar-item" aria-label="lazy组件"><!--[--><!--]--> lazy组件 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Hooks <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/technology/ILoveDevelop/react/hooks/start.md" class="sidebar-item" aria-label="基础"><!--[--><!--]--> 基础 <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/hooks/useState.md" class="sidebar-item" aria-label="useState"><!--[--><!--]--> useState <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/hooks/useEffect.md" class="sidebar-item" aria-label="useEffect"><!--[--><!--]--> useEffect <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/hooks/hooksOther.md" class="sidebar-item" aria-label="其他API"><!--[--><!--]--> 其他API <!--[--><!--]--></a><!----></li><li><a href="/technology/ILoveDevelop/react/hooks/hooksCommon.md" class="sidebar-item" aria-label="通用API"><!--[--><!--]--> 通用API <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="expirationtime-公式" tabindex="-1"><a class="header-anchor" href="#expirationtime-公式" aria-hidden="true">#</a> <strong>expirationTime 公式</strong></h2><p>讲公式就有必要把代码亮出来了，毕竟代码量也不多</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">UNIT_SIZE</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">const</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">=</span> <span class="token number">2</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">msToExpirationTime</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">ms</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token constant">UNIT_SIZE</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">expirationTime</span><span class="token operator">:</span> ExpirationTime</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">-</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">UNIT_SIZE</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ceiling</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">num</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">precision</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">/</span> precision<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> precision
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">computeExpirationBucket</span><span class="token punctuation">(</span>
    <span class="token parameter">currentTime<span class="token punctuation">,</span>
    expirationInMs<span class="token punctuation">,</span>
    bucketSizeMs<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">+</span>
        <span class="token function">ceiling</span><span class="token punctuation">(</span>
            currentTime <span class="token operator">-</span> <span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">+</span> expirationInMs <span class="token operator">/</span> <span class="token constant">UNIT_SIZE</span><span class="token punctuation">,</span>
            bucketSizeMs <span class="token operator">/</span> <span class="token constant">UNIT_SIZE</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LOW_PRIORITY_EXPIRATION</span> <span class="token operator">=</span> <span class="token number">5000</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LOW_PRIORITY_BATCH_SIZE</span> <span class="token operator">=</span> <span class="token number">250</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computeAsyncExpiration</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">currentTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">computeExpirationBucket</span><span class="token punctuation">(</span>
        currentTime<span class="token punctuation">,</span>
        <span class="token constant">LOW_PRIORITY_EXPIRATION</span><span class="token punctuation">,</span>
        <span class="token constant">LOW_PRIORITY_BATCH_SIZE</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">HIGH_PRIORITY_EXPIRATION</span> <span class="token operator">=</span> __DEV__ <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">150</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">HIGH_PRIORITY_BATCH_SIZE</span> <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computeInteractiveExpiration</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">currentTime</span><span class="token operator">:</span> ExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">computeExpirationBucket</span><span class="token punctuation">(</span>
        currentTime<span class="token punctuation">,</span>
        <span class="token constant">HIGH_PRIORITY_EXPIRATION</span><span class="token punctuation">,</span>
        <span class="token constant">HIGH_PRIORITY_BATCH_SIZE</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>React 中有两种类型的<code>ExpirationTime</code>，一个是<code>Interactive</code>的，另一种是普通的异步。<code>Interactive</code>的比如说是由事件触发的，那么他的响应优先级会比较高因为涉及到交互。</p><p>在整个计算公式中只有<code>currentTime</code>是变量，也就是当前的时间戳。拿<code>computeAsyncExpiration</code>举例，在<code>computeExpirationBucket</code>中接收的就是<code>currentTime</code>、<code>5000</code>和<code>250</code></p><p>最终的公式就是酱紫的：<code>((((currentTime - 2 + 5000 / 10) / 25) | 0) + 1) * 25</code></p><p>其中<code>25</code>是<code>250 / 10</code>，<code>| 0</code>的作用是取整数</p><p>翻译一下就是：<strong>当前时间加上<code>498</code>然后处以<code>25</code>取整再加<code>1</code>再乘以 <code>5</code>，需要注意的是这里的<code>currentTime</code>是经过<code>msToExpirationTime</code>处理的，也就是<code>((now / 10) | 0) + 2</code>，所以这里的减去<code>2</code>可以无视，而除以 <code>10</code> 取整应该是要抹平 <code>10</code> 毫秒内的误差，当然最终要用来计算时间差的时候会调用<code>expirationTimeToMs</code>恢复回去，但是被取整去掉的 <code>10</code> 毫秒误差肯定是回不去的</strong>。</p><p>现在应该很明白了吧？再解释一下吧：简单来说在这里，最终结果是以<code>25</code>为单位向上增加的，比如说输入<code>10002 - 10026</code>之间，最终得到的结果都是<code>10525</code>，但是到了<code>10027</code>的到的结果就是<code>10550</code>，这就是除以<code>25</code>取整的效果。</p><p>另外一个要提的就是<code>msToExpirationTime</code>和<code>expirationTimeToMs</code>方法，他们是想换转换的关系。<strong>有一点非常重要，那就是用来计算<code>expirationTime</code>的<code>currentTime</code>是通过<code>msToExpirationTime(now)</code>得到的，也就是预先处理过的，先处以<code>10</code>再加了<code>2</code>，所以后面计算<code>expirationTime</code>要减去<code>2</code>也就不奇怪了</strong></p><h2 id="小结一下" tabindex="-1"><a class="header-anchor" href="#小结一下" aria-hidden="true">#</a> <strong>小结一下</strong></h2><p>React 这么设计抹相当于抹平了<code>25ms</code>内计算过期时间的误差，那他为什么要这么做呢？思考了很久都没有得到答案，直到有一天盯着代码发呆，看到<code>LOW_PRIORITY_BATCH_SIZE</code>这个字样，<code>bacth</code>，是不是就对应<code>batchedUpdates</code>？再细想了一下，这么做也许是为了让非常相近的两次更新得到相同的<code>expirationTime</code>，然后在一次更新中完成，相当于一个自动的<code>batchedUpdates</code>。</p><p>不禁感叹，真的是细啊！</p><p>以上就是<code>expirationTime</code>的计算方法。</p><h2 id="currenttime" tabindex="-1"><a class="header-anchor" href="#currenttime" aria-hidden="true">#</a> <strong>currentTime</strong></h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentSchedulerTime
    <span class="token punctuation">}</span>
    <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        nextFlushedExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
        nextFlushedExpirationTime <span class="token operator">===</span> Never
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        currentSchedulerTime <span class="token operator">=</span> currentRendererTime
        <span class="token keyword">return</span> currentSchedulerTime
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> currentSchedulerTime
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在 React 中计算<code>expirationTime</code>要基于当前得时钟时间，一般来说只需要获取<code>Date.now</code>或者<code>performance.now</code>就可以了，但是每次获取一下呢比较消耗性能，所以呢 React 设置了<code>currentRendererTime</code>来记录这个值，用于一些不需要重新计算得场景。</p><p>但是在 React 中呢又提供了<code>currentSchedulerTime</code>这个变量，同样也是记录这个值的，那么为什么要用两个值呢？看一下<code>requestCurrentTime</code>方法的实现。</p><h2 id="首先是" tabindex="-1"><a class="header-anchor" href="#首先是" aria-hidden="true">#</a> <strong>首先是</strong>:</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> currentSchedulerTime
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个<code>isRendering</code>只有在<code>performWorkOnRoot</code>的时候才会被设置为<code>true</code>，而其本身是一个同步的方法，不存在他执行到一半没有设置<code>isRendering</code>为<code>false</code>的时候就跳出，那么什么情况下会在这里出现新的<code>requestCurrentTime</code>呢？</p><ul><li><p>在生命周期方法中调用了<code>setState</code></p></li><li><p>需要挂起任务的时候</p></li></ul><p>也就是说 React 要求<strong>在一次<code>rendering</code>过程中，新产生的<code>update</code>用于计算过期时间的<code>current</code>必须跟目前的<code>renderTime</code>保持一致，同理在这个周期中所有产生的新的更新的过期时间都会保持一致</strong>！</p><h2 id="然后第二个判断" tabindex="-1"><a class="header-anchor" href="#然后第二个判断" aria-hidden="true">#</a> <strong>然后第二个判断</strong>:</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
    nextFlushedExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
    nextFlushedExpirationTime <span class="token operator">===</span> Never
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>也就是说在一个<code>batched</code>更新中，只有第一次创建更新才会重新计算时间，后面的所有更新都会复用第一次创建更新的时候的时间，这个也是为了<strong>保证在一个批量更新中产生的同类型的更新只会有相同的过期时间</strong></p><h2 id="各种不同的-expirationtime" tabindex="-1"><a class="header-anchor" href="#各种不同的-expirationtime" aria-hidden="true">#</a> <strong>各种不同的 expirationTime</strong></h2><p>在 React 的调度过程中存在着非常多不同的<code>expirationTime</code>变量帮助 React 去实现在单线程环境中调度不同优先级的任务这个需求，这篇文章就来一一列举他们的含义以及作用，来帮助更好得理解 React 中的整个调度过程。</p><ul><li><p><code>root.expirationTime</code></p></li><li><p><code>root.nextExpirationTimeToWorkOn</code></p></li><li><p><code>root.childExpirationTime</code></p></li><li><p><code>root.earliestPendingTime</code> &amp; <code>root.lastestPendingTime</code></p></li><li><p><code>root.earliestSuspendedTime</code> &amp; <code>root.lastestSuspendedTime</code></p></li><li><p><code>root.lastestPingedTime</code></p></li><li><p><code>nextFlushedExpirationTime</code></p></li><li><p><code>nextLatestAbsoluteTimeoutMs</code></p></li><li><p><code>currentRendererTime</code></p></li><li><p><code>currentSchedulerTime</code></p></li></ul><p>另外，所有节点都会具有<code>expirationTime</code>和<code>childExpirationTime</code>两个属性</p><p>以上所有值初始都是<code>NoWork</code>也就是<code>0</code>，以及他们一共会有三种情况：</p><ul><li><p><code>NoWork</code>，代表没有更新</p></li><li><p><code>Sync</code>，代表同步执行，不会被调度也不会被打断</p></li><li><p><code>async</code>模式下计算出来的过期时间，一个时间戳</p></li></ul><p>接下去的例子都会根据下面的例子结构来讲，假设有如下结构的一个 React 节点树，他的<code>Fiber</code>结构如下：</p><p><img src="https://kgfacq.dm.files.1drv.com/y4mdey9O6FJ59ftJnhP1ej6YNMd0z1HWSQsmF42mJjlUiM8fVYKjcyV-0AlUvMdE5SpBHkRl7Wn_WcqaBlhtY-ifm4GLrc_whI9LlUsJyeKOdbmcwCdlqByqYRkCdbjm-6I8d0MuICm3TeAxxyttW3SNKRLWYPeinkDSrH31VLXI4I5M9IJ60x8d6RR1OtOcctUwRNExxMvS6yFQVUEuBulKA?width=721&amp;height=471&amp;cropmode=none" alt="结构图"></p><p>后续会在这个基础上讲解不同情况下<code>expirationTime</code>的情况</p><h2 id="childexpirationtime" tabindex="-1"><a class="header-anchor" href="#childexpirationtime" aria-hidden="true">#</a> <strong>childExpirationTime</strong></h2><p>在之前说过，每次一个节点调用<code>setState</code>或者<code>forceUpdate</code>都会产生一个更新并且计算一个<code>expirationTime</code>，那么这个节点的<code>expirationTime</code>就是当时计算出来的值，<strong>因为这个更新本身就是由这个节点产生的</strong></p><p>最终因为 React 的更新需要从<code>FiberRoot</code>开始，所以会执行一次向上遍历找到<code>FiberRoot</code>，而向上遍历则正好是一步步找到<strong>创建更新的节点的父节点</strong>的过程，这时候 React 就会对每一个该节点的父节点链上的节点设置<code>childExpirationTime</code>，因为这个更新是他们的子孙节点造成的</p><p><img src="https://h2facq.dm.files.1drv.com/y4mphJBnkRInXVdei2q3h0etKGLWTB5irIH2w23DMcoAKRIl0K7EJPFHjykQ5enpm5lgi_Jp9qTPhBTM64CQF2J_6wxtL1j2raUeLNUm7zXZzclXJQ6iPXjw75oGcdUMdsYCKNm2YawmEsJy2joPddhFLBN4PK51oGM16974Ad3A7azsRa0NunaDYNB1Lvhb3ZMrwKrx-3Yvi90e4vW3A02Iw?width=841&amp;height=571&amp;cropmode=none" alt="更新节点"></p><p>如上图所示，先忽略最左边的<code>child1</code>产生的一次异步更新，如果当前只有<code>child2</code>产生了一个<code>Sync</code>更新，那么<code>App</code>和<code>FiberRoot</code>的<code>childExpirationTime</code>都会更新成<code>Sync</code></p><p>那么这个值有什么用呢？在向下更新整棵<code>Fiber</code>树的时候，每个节点都会执行对应的<code>update</code>方法，在这个方法里面就会使用节点本身的<code>expirationTime</code>和<code>childExpirationTime</code>来判断他是否可以直接跳过，不更新子树。<strong><code>expirationTime</code>代表他本身是否有更新，如果他本身有更新，那么他的更新可能会影响子树；<code>childExpirationTime</code>表示他的子树是否产生了更新；如果两个都没有，那么子树是不需要更新的。</strong></p><p>对应图中，如果<code>child1</code>，<code>child3</code>，<code>child4</code>还有子树，那么在这次<code>child2</code>的更新中，他们是不需要重新渲染的，在遍历到他们的时候，会直接跳过</p><p><em><strong>注意：这里只讨论没有其他副作用的情况，比如使用老的<code>context api</code>之类的最终会强制导致没有更新的组件重新渲染的情况先不考虑。</strong></em></p><p>了解了<code>childExpirationTime</code>的作用之后，再来讲一下他的特性：</p><ul><li><p>同一个节点产生的连续两次更新，最红在父节点上只会体现一次<code>childExpirationTime</code></p></li><li><p>不同子树产生的更新，最终体现在跟节点上的是优先级最高的那个更新</p></li></ul><p>第一点很好理解，同一个节点在第一次更新还没有结束的情况下再次产生更新，那么不管他们优先级哪个高，最终都会按照高优先级那个过期时间把所有更新都更新掉了，因为<code>Fiber</code>对象只有一个，<code>updateQueue</code>也只有一个，无法区分同一个对象上连续的不同更新。</p><p>第二点是因为 React 在创建更新向上寻找<code>root</code>并设置<code>childExpirationTime</code>的时候，会对比之前设置过的和现在的，最终会等于<strong>非<code>NoWork</code>的最小的<code>childExpirationTime</code>，因为<code>expirationTime</code>越小优先级越高，<code>Sync</code>是最高优先级</strong></p><p>对应到上面的例子中，<code>child1</code>产生的更新是异步的，所以他的<code>expirationTime</code>是计算出来的时间戳，那么肯定比<code>Sync</code>大，所以率先记录到父节点的是<code>child2</code>，同时也是<code>child2</code>的更新先被执行。<strong>即便是<code>child1</code>的更新先产生，如果他在<code>chidl2</code>产生更新的时候他还没更新完，那么也会被打断，先完成<code>child2</code>的渲染，再回头来渲染<code>child1</code></strong></p><p>以上是<code>childExpirationTime</code>的作用和特性，他在每个节点<code>completeWork</code>的时候会<code>reset</code>父链上的<code>childExpirationTime</code>，也就是说这个节点已经更新完了，那么他的<code>childExpirationTime</code>也就没有意义了。那么这个在讲节点更新的时候会讲到，到时候大家再对应起来看效果会更好。</p><h2 id="pendingtime" tabindex="-1"><a class="header-anchor" href="#pendingtime" aria-hidden="true">#</a> <strong>pendingTime</strong></h2><p>在<code>FiberRoot</code>上有两个值<code>earliestPendingTime</code>和<code>lastestPedingTime</code>，他们是一对值，<strong>用来记录所有子树中需要进行渲染的更新的<code>expirationTime</code>的区间</strong></p><p><img src="https://hmfacq.dm.files.1drv.com/y4mTm9k8wciS1LTgRpOidtojQQIgCWVhDtXluYnvYIqbK0Z6NUXFqzm76SlooXVfTHb9sAU2pE7du3AbbR23JlZU0vJ1FghvT6X5HXcoguLi4Mp4PdE25AGFt_1w2NJ1K7o3UiqV3mH-kWnlEuWd5xPlkueCdm2FfYDWvCT40ynsrbziTCoE7QMxIbpHyAg6fYkKPHh0qRDY5vrK8ssy8jzuQ?width=841&amp;height=586&amp;cropmode=none" alt="FiberRoot 更新的示例图"></p><p>在这个例子里，同时在<code>child1</code>、<code>child2</code>、<code>child3</code>产生里更新，并且根据优先级计算出了不同的更新时间（<strong>再次重申，请忽略细节，现实中不太会出现同时产生的情况</strong>）。</p><p>每个更新创建的时候，React 会通过<code>markPendingPriorityLevel</code>标记<code>root</code>节点的<code>earliestPendingTime</code>和<code>lastestPedingTime</code>。他们只记录区间，也就是说现在产生了三个不同的过期时间，但是这里只记录最大和最小的。</p><p>那么他的作用就很明显了，<strong>通过追踪最大和最小值，React 可以判断在当前更新之后是否还具有优先级更低的任务需要执行（当前过期时间处理这两个值之间）</strong>。</p><h2 id="suspendedtime" tabindex="-1"><a class="header-anchor" href="#suspendedtime" aria-hidden="true">#</a> <strong>suspendedTime</strong></h2><p>同样的在<code>ReactFiber</code>上有两个值<code>earliestSuspendedTime</code>和<code>lastestSuspendedTime</code>，<strong>这两个值是用来记录被挂起的任务的过期时间的</strong></p><p>首先定义一下什么情况下任务是被挂起的：</p><ul><li><p>出现可捕获的错误并且还有优先级更低的任务的情况下</p></li><li><p>当捕获到<code>thenable</code>，并且需要设置<code>onTimeout</code>的时候</p></li></ul><p>称这个任务被<code>suspended</code>(挂起)了。记录这个时间主要是在<code>resolve</code>了<code>promise</code>之后，判断被挂起的组件更新是否依然处于目前已有的<code>suspenedTime</code>中间，如果不是的话是需要重新计算一个新的过期时间，然后从新加入队列进行调度更新的。</p><p>另外就是在确定目前需要执行的任务的过期时间，也就是<code>root.expirationTime</code>和<code>root.nextExpirationTimeToWorkOn</code>的时候也是一个考虑因素</p><h2 id="lastestpingedtime" tabindex="-1"><a class="header-anchor" href="#lastestpingedtime" aria-hidden="true">#</a> <strong>lastestPingedTime</strong></h2><p>这个值是用来记录最新的一次<code>suspended</code>组件<code>resolve</code>之后，如果挂起之前的<code>expirationTime</code>依然在<code>earliestSuspendedTime</code>和<code>lastestSuspendedTime</code>之间，则会标志这个时间为<code>pingedTime</code></p><p><code>pingedTime</code>目前看来没有什么别的作用，唯一跟<code>suspendedTime</code>的区别是他的优先级比<code>suspendedTime</code>高一些，会优先选择为渲染目标。</p><h2 id="root-expirationtime-和-root-nextexpirationtimetoworkon" tabindex="-1"><a class="header-anchor" href="#root-expirationtime-和-root-nextexpirationtimetoworkon" aria-hidden="true">#</a> <strong>root.expirationTime 和 root.nextExpirationTimeToWorkOn</strong></h2><p><code>root.expirationTime</code>是用来标志当前渲染的过期时间的，请注意他只管本渲染周期，他并不管现在的渲染目标是哪个，渲染目标是由<code>root.nextExpirationTimeToWorkOn</code>来决定的。</p><p>那么他们有什么区别呢？主要区别在于发挥作用的阶段</p><ul><li><p><code>expirationTime</code>作用于调度阶段，主要指责是：</p><ul><li><p>决定是异步执行渲染还是同步执行渲染</p></li><li><p>作为<code>react-scheduler</code>的<code>timeout</code>标准，决定是否要优先渲染</p></li></ul></li><li><p><code>nextExpirationTimeToWorkOn</code>主要作用于渲染阶段：</p><ul><li><p>决定那些更新要在当前周期中被执行</p></li><li><p>通过跟每个节点的<code>expirationTime</code>比较决定该节点是否可以直接<code>bailout</code>（跳过）</p></li></ul></li></ul><p>他们都是通过<code>pendingTime</code>、<code>suspenededTime</code>和<code>pingedTime</code>中删选出来的，唯一的不同是，<code>nextExpirationTimeToWorkOn</code>在没有<code>pending</code>或者<code>pinged</code>的任务的时候会选择最晚的<code>suspendedTime</code>，而<code>expirationTime</code>会选择最早的</p><ul><li><p><code>expirationTime</code>的变化：</p><ul><li><p>在<code>scheduleWork</code>的时候通过<code>markPendingExpirationTime</code>设置</p></li><li><p>在<code>beginWork</code>的时候被设置为<code>NoWork</code></p></li><li><p>在<code>onUncaughtError</code>的时候设置为<code>NoWork</code></p></li><li><p><code>onSuspend</code>的时候又会设置回当次更新的<code>expirationTime</code></p></li></ul></li></ul><p><strong>目前不是很稳定</strong></p><p>展示一下代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">findNextExpirationTimeToWorkOn</span><span class="token punctuation">(</span><span class="token parameter">completedExpirationTime<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> earliestSuspendedTime <span class="token operator">=</span> root<span class="token punctuation">.</span>earliestSuspendedTime
    <span class="token keyword">const</span> latestSuspendedTime <span class="token operator">=</span> root<span class="token punctuation">.</span>latestSuspendedTime
    <span class="token keyword">const</span> earliestPendingTime <span class="token operator">=</span> root<span class="token punctuation">.</span>earliestPendingTime
    <span class="token keyword">const</span> latestPingedTime <span class="token operator">=</span> root<span class="token punctuation">.</span>latestPingedTime

    <span class="token keyword">let</span> nextExpirationTimeToWorkOn <span class="token operator">=</span>
        earliestPendingTime <span class="token operator">!==</span> NoWork <span class="token operator">?</span> earliestPendingTime <span class="token operator">:</span> latestPingedTime

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        nextExpirationTimeToWorkOn <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>completedExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
        latestSuspendedTime <span class="token operator">&gt;</span> completedExpirationTime<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextExpirationTimeToWorkOn <span class="token operator">=</span> latestSuspendedTime
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> expirationTime <span class="token operator">=</span> nextExpirationTimeToWorkOn
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        expirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
        earliestSuspendedTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
        earliestSuspendedTime <span class="token operator">&lt;</span> expirationTime
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        expirationTime <span class="token operator">=</span> earliestSuspendedTime
    <span class="token punctuation">}</span>

    root<span class="token punctuation">.</span>nextExpirationTimeToWorkOn <span class="token operator">=</span> nextExpirationTimeToWorkOn
    root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>每次开始调度任务，或者设置<code>pendingTime</code>、<code>suspendedTime</code>、<code>pingedTime</code>都会调用这个方法重新删选接下去执行的任务。</p><p>需要注意一点，并不是所有情况都是从这个方法删选出这两个值的，比如在<code>renderRoot</code>出现错误捕获，并且没有更低优先级的任务的时候，强制以同步的方式把当前<code>expirationTime</code>的任务再重新执行了一遍</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>root<span class="token punctuation">.</span>didError <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token keyword">const</span> suspendedExpirationTime <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>nextExpirationTimeToWorkOn <span class="token operator">=</span> expirationTime<span class="token punctuation">)</span>
<span class="token keyword">const</span> rootExpirationTime <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> Sync<span class="token punctuation">)</span>
<span class="token comment">// 什么事情都不做，回到主线程</span>
<span class="token function">onSuspend</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    rootWorkInProgress<span class="token punctuation">,</span>
    suspendedExpirationTime<span class="token punctuation">,</span>
    rootExpirationTime<span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// Indicates no timeout</span>
<span class="token punctuation">)</span>
<span class="token keyword">return</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这里直接把<code>root.expirationTime</code>设置为<code>Sync</code>，然后直接<code>return</code>，这样回到<code>performWork</code>的时候调用<code>findHighestPriorityRoot</code>会直接设置当前<code>root</code>为下一个渲染的目标，然后再次进行渲染。<code>performWork</code>的循环在<code>fiber-scheduler</code>中有详细讲解</p><h2 id="nextflushedexpirationtime" tabindex="-1"><a class="header-anchor" href="#nextflushedexpirationtime" aria-hidden="true">#</a> <strong>nextFlushedExpirationTime</strong></h2><p>这个是在<code>fiber-scheduler</code>中的一个全局变量，用来记录下一个需要渲染的<code>FiberRoot</code>的过期时间。注意他删选的时候整个应用中所有<code>FiberRoot</code>的优先级（是的，没看错，应该 React 应用是可以有多个<code>FiberRoot</code>，比如执行两次<code>ReactDOM.render</code>），并不关心每个<code>FiberRoot</code>子树的优先级。</p><p>他是在<code>findHighestPriorityRoot</code>中被赋值的，会遍历<code>firstScheduleRoot -&gt; lastScheduledRoot</code>链表中所有<code>root</code>，并找到优先级最高（也就是<code>expirationTime</code>最小）的那个<code>root</code>进行赋值，并安排渲染</p><h2 id="nextlatestabsolutetimeoutms" tabindex="-1"><a class="header-anchor" href="#nextlatestabsolutetimeoutms" aria-hidden="true">#</a> <strong>nextLatestAbsoluteTimeoutMs</strong></h2><p>他的作用是在<code>Suspense</code>组件捕获到挂起之后，增加一个<code>timeout</code>来强制重新渲染一次的，不过目前看不出这个<code>timeout</code>有什么用</p><p>这个跟<code>Suspense</code>组件的<code>maxDuration</code>有关，但是官方没公布用法，从源码中也看不出有什么用处，原以为是<strong>多少毫秒内不显示<code>fallback</code>的内容</strong>，结果测试了一下发现没用。等有空再研究一下，或者等官方正式发布吧，毕竟现在就算研究出来了，可能分分钟就被改了，16.5 的时候还叫<code>delayMs</code>，16.6 就改成<code>maxDuration</code>了。</p><h2 id="currentschedulertime-currentrenderertime" tabindex="-1"><a class="header-anchor" href="#currentschedulertime-currentrenderertime" aria-hidden="true">#</a> <strong>currentSchedulerTime &amp; currentRendererTime</strong></h2><p>这两个时间是用来是用来记录当前时间的，在<strong>计算过期时间</strong>和<strong>比较任务是否过期</strong>的时候都会用到<code>currentRendererTime</code>，<code>currentSchedulerTime</code>大部分时候都是等于<code>currentRendererTime</code>的，那为什么要设置两个时间呢？</p><p>这就是因为<code>batchedUpdates</code>了，在这种情况下如果同时创建了多个更新是会为每次更新计算过期时间的，而计算是要花时间的，如果每次都是请求当前时间，那么同一个<code>batch</code>中的不同更新得到的过期时间就会是不一样的，所以在一个<code>batch</code>中获取的当前时间应该是一样的，所以就设置了这么一个值，在请求当前时间的方法中有这么一段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
    nextFlushedExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span>
    nextFlushedExpirationTime <span class="token operator">===</span> Never
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    currentSchedulerTime <span class="token operator">=</span> currentRendererTime
    <span class="token keyword">return</span> currentSchedulerTime
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>findHighestPriorityRoot</code>会设置<code>nextFlushedExpirationTime</code>，也就是只有在当前没有等待中的更新的情况下，才会重新计算当前时间。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 87403071+dean-57blocks@users.noreply.github.com">dean-57blocks</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/technology/assets/app.ba47fc91.js" defer></script>
  </body>
</html>
